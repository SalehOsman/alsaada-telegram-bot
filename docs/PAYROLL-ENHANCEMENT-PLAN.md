# ๐ ุฎุทุฉ ุชุทููุฑ ูุธุงู ุงูุฑูุงุชุจ ูุงูุชุณููุงุช ุงููุงููุฉ

## ๐ฏ ุงููุฏู ุงูุนุงู
ุชุทููุฑ ูุธุงู ุดุงูู ูุฅุฏุงุฑุฉ ุงูุฑูุงุชุจ ูุงูุชุณููุงุช ุงููุงููุฉ ูุน ุชุชุจุน ูุงูู ููุณุฌู ุงููุงูู ููู ููุธู

---

## โ ุงููุฑุญูุฉ 1: ุชุญุฏูุซ ูุธุงู ุงูุฑูุงุชุจ ุงูุฃุณุงุณู (ููุชูู)

### ุงูุชุบููุฑุงุช ุงููููุฐุฉ:
- โ ุนุฑุถ ุฌููุน ุงูููุธููู (ูุดุทูู ูุณุงุจููู) ูู ูุงุฆูุฉ ุญุณุงุจ ุงูุฑูุงุชุจ
- โ ุฅุฎูุงุก ููุท ุงูุนูุงู ุงูุฐูู ุญุงูุชูู `SETTLED` (ุชูุช ุงูุชุณููุฉ ุงููุงููุฉ)
- โ ุฅููุงููุฉ ุญุณุงุจ ูุณุชุญูุงุช ุฃู ููุธู ุจุบุถ ุงููุธุฑ ุนู ูุฌูุฏ ูุนุงููุงุช
- โ ุนูุงูุฉ ุชูููุฒ ๐ด ููุนูุงู ุงูุณุงุจููู

### ุงูููุฏ ุงููููุฐ:
```typescript
// ุงุณุชุจุนุงุฏ ููุท ุงูุนูุงู ุงููุณูุงุฉ ุญุณุงุจุงุชูู ุจุงููุงูู
const employees = await Database.prisma.employee.findMany({
  where: {
    isActive: true,
    NOT: { employmentStatus: 'SETTLED' }
  }
})
```

---

## ๐ ุงููุฑุญูุฉ 2: ุชูุฑูุฑ ุงูุณุฌู ุงููุงูู ููููุธู

### ุงููุฏู:
ุฅูุดุงุก ุชูุฑูุฑ ุดุงูู ูุนุฑุถ "ุชุงุฑูุฎ ุงูุญูุงุฉ ุงููุงููุฉ" ููู ููุธู ุจุงูุชูุตูู ุงููุงูู

### ุงููุชุทูุจุงุช:

#### 2.1 ูุนูููุงุช ุฃุณุงุณูุฉ
- ุงูุงุณู ุงููุงูู ูุฑูู ุงูููุธู
- ุงููุณู ูุงููุธููุฉ
- ุชุงุฑูุฎ ุงูุชุนููู - ุชุงุฑูุฎ ุงูุฅููุงุก (ุฅู ูุฌุฏ)
- ุงููุฏุฉ ุงููููุฉ ููุนูู

#### 2.2 ุงูุฑูุงุชุจ ุงูุดูุฑูุฉ
```
๐ ุฃูุชูุจุฑ 2024
โ ุงูุฑุงุชุจ ุงูุฃุณุงุณู: 20,000 ุฌููู
โ ุงูุจุฏูุงุช: 1,500 ุฌููู
โ ุงูููุงูุขุช: 500 ุฌููู
โ ุงูุฎุตููุงุช: 800 ุฌููู
โ ุงูุตุงูู: 21,200 ุฌููู
   โ ุชู ุงูุณุฏุงุฏ ูู 31/10/2024
```

#### 2.3 ุงููุนุงููุงุช ุงููุงููุฉ
- ุงูุณูู ุงูููุฏูุฉ (ุงูุชุงุฑูุฎุ ุงููุจูุบุ ุงูุญุงูุฉ)
- ุงููุณุญูุจุงุช ุงูุนูููุฉ (ุงูุชุงุฑูุฎุ ุงูุตููุ ุงููููุฉ)
- ุงูุฏููู ุงููุณุชุญูุฉ
- ุญุงูุฉ ุงูุชุณููุฉ ููู ูุนุงููุฉ

#### 2.4 ุงูููุฎุต ุงููุงูู
```
๐ฐ ุฅุฌูุงูู ุงููุณุชุญูุงุช: 250,000 ุฌููู
๐ธ ุฅุฌูุงูู ุงููุฏููุน: 248,500 ุฌููู
โ๏ธ ุงููุชุจูู: 1,500 ุฌููู
```

### ุฎุทุฉ ุงูุชูููุฐ:
1. ุฅูุดุงุก handler ุฌุฏูุฏ: `payroll-financial-history.handler.ts`
2. ุฅุถุงูุฉ ูุณู "๐ ุงูุณุฌู ุงููุงูู" ูู ูุงุฆูุฉ ุงูุฑูุงุชุจ
3. ุงุณุชุนูุงูุงุช ูู:
   - `HR_PayrollRecord` (ูุดูู ุงูุฑูุงุชุจ)
   - `HR_Transaction` (ุฌููุน ุงููุนุงููุงุช)
   - `HR_EmployeeAllowance` (ุงูุจุฏูุงุช)
   - `HR_EmployeeBonus` (ุงูููุงูุขุช)

---

## ๐ ุงููุฑุญูุฉ 3: ุชูุฑูุฑ ุงูุนูุงู ุงูุณุงุจููู

### ุงููุฏู:
ุนุฑุถ ูุงุฆูุฉ ุดุงููุฉ ุจุฌููุน ุงูุนูุงู ุงูุณุงุจููู ูุน ููุฎุต ูุณุชุญูุงุชูู

### ุงููุชุทูุจุงุช:

#### 3.1 ูุงุฆูุฉ ุงูุนูุงู ุงูุณุงุจููู
```
๐ฅ ุงูุนูุงู ุงูุณุงุจููู (15 ุนุงูู)

1. ุฃุญูุฏ ูุญูุฏ ุนูู
   ๐ ุงููุชุฑุฉ: 1/1/2023 - 30/9/2024
   ๐ฐ ุฅุฌูุงูู ุงููุณุชุญูุงุช: 150,000 ุฌููู
   โ ุงูุญุงูุฉ: ูุณูู ุจุงููุงูู
   
2. ูุญููุฏ ุญุณู
   ๐ ุงููุชุฑุฉ: 1/3/2024 - 15/10/2024
   ๐ฐ ุฅุฌูุงูู ุงููุณุชุญูุงุช: 80,000 ุฌููู
   โ๏ธ ุงูุญุงูุฉ: ูุชุจูู 2,500 ุฌููู
```

#### 3.2 ููุชุฑุฉ ูุจุญุซ
- ุงูุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ
- ููุชุฑ ุญุณุจ ุงูุญุงูุฉ (ูุณูู/ุบูุฑ ูุณูู)
- ููุชุฑ ุญุณุจ ุชุงุฑูุฎ ุงูุฅููุงุก
- ุชุฑุชูุจ ุญุณุจ ุงููุชุจูู (ุงูุฃุนูู ุฃููุงู)

#### 3.3 ุฅุญุตุงุฆูุงุช ุนุงูุฉ
```
๐ ุฅุญุตุงุฆูุงุช ุงูุนูุงู ุงูุณุงุจููู
โ ุฅุฌูุงูู ุงูุนุฏุฏ: 15 ุนุงูู
โ ูุณูู ุจุงููุงูู: 10 ุนูุงู
โ ุบูุฑ ูุณูู: 5 ุนูุงู
โ ุฅุฌูุงูู ุงููุชุจูู: 12,500 ุฌููู
```

### ุฎุทุฉ ุงูุชูููุฐ:
1. ุฅูุดุงุก handler ุฌุฏูุฏ: `payroll-former-employees.handler.ts`
2. ุฅุถุงูุฉ ุฒุฑ "๐ฅ ุงูุนูุงู ุงูุณุงุจููู" ูู ูุงุฆูุฉ ุงูุชูุงุฑูุฑ
3. ุงุณุชุนูุงูุงุช ูุนูุฏุฉ ูุน aggregation

---

## ๐ ุงููุฑุญูุฉ 4: ูุธุงู ุงูุชุณููุงุช ุงููุงููุฉ

### ุงููุฏู:
ุชุชุจุน ุฏููู ูุญุงูุฉ ุงูุณุฏุงุฏ ูุงููุจุงูุบ ุงููุณุฏุฏุฉ ูุนููุงู ูุน ุงูุงุณุชุนุฏุงุฏ ููุฑุจุท ุจุงูุฎุฒููุฉ

### ุงูุชุตููู ุงูููุชุฑุญ:

#### 4.1 ุฌุฏูู ุฌุฏูุฏ: `HR_PayrollSettlement`
```prisma
model HR_PayrollSettlement {
  id                Int      @id @default(autoincrement())
  
  // ุฑุจุท ุจูุดู ุงูุฑุงุชุจ
  payrollRecordId   Int
  payrollRecord     HR_PayrollRecord @relation(fields: [payrollRecordId])
  
  // ูุนูููุงุช ุงูููุธู (ูููุตูู ุงูุณุฑูุน)
  employeeId        Int
  employee          Employee @relation(fields: [employeeId])
  
  // ุงููุจุงูุบ
  totalAmount       Float    // ุฅุฌูุงูู ุงููุณุชุญู
  paidAmount        Float    // ุงููุจูุบ ุงููุณุฏุฏ ูุนููุงู
  remainingAmount   Float    // ุงููุชุจูู
  
  // ุญุงูุฉ ุงูุณุฏุงุฏ
  settlementStatus  SettlementStatus @default(PENDING)
  
  // ุชูุงุตูู ุงูุณุฏุงุฏ
  paymentMethod     PaymentMethod?
  paymentDate       DateTime?
  paymentReference  String?  // ุฑูู ูุฑุฌุนู ููุณุฏุงุฏ
  
  // ุฑุจุท ุจุงูุฎุฒููุฉ (ุฌุงูุฒ ูููุณุชูุจู)
  treasuryId        Int?
  treasury          Treasury? @relation(fields: [treasuryId])
  
  // ููุงุญุธุงุช
  notes             String?
  
  // ุงูุชุชุจุน
  createdAt         DateTime @default(now())
  createdBy         Int
  updatedAt         DateTime @updatedAt
  updatedBy         Int?
}

enum SettlementStatus {
  PENDING         // ูู ุงูุชุธุงุฑ ุงูุณุฏุงุฏ
  PARTIAL         // ุณุฏุงุฏ ุฌุฒุฆู
  COMPLETED       // ูุณุฏุฏ ุจุงููุงูู
  CANCELLED       // ููุบู
  OVERDUE         // ูุชุฃุฎุฑ
}

enum PaymentMethod {
  CASH            // ููุฏู
  BANK_TRANSFER   // ุชุญููู ุจููู
  CHECK           // ุดูู
  DEDUCTION       // ุฎุตู ูู ุงูุฑุงุชุจ
  OTHER           // ุทุฑููุฉ ุฃุฎุฑู
}
```

#### 4.2 ูุงุฌูุฉ ุงููุณุชุฎุฏู

**ุนูุฏ ุญูุธ ูุดู ุงูุฑุงุชุจ:**
```
โ ุชู ุญูุธ ูุดู ุงูุฑุงุชุจ ุจูุฌุงุญ

๐ฐ ุตุงูู ุงูุฑุงุชุจ: 21,200 ุฌููู

๐ ุชุณุฌูู ุนูููุฉ ุงูุณุฏุงุฏุ
โโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ต ุณุฏุงุฏ ููุฏู       โ
โ ๐ฆ ุชุญููู ุจููู     โ
โ ๐ ุดูู            โ
โ โณ ุณุฏุงุฏ ูุงุญู      โ
โ โ ุฅูุบุงุก          โ
โโโโโโโโโโโโโโโโโโโโโโโ
```

**ุฅุฐุง ุงุฎุชุงุฑ "ุณุฏุงุฏ ููุฏู":**
```
๐ต ุชุณุฌูู ุณุฏุงุฏ ููุฏู

โ ุงููุจูุบ ุงููุณุชุญู: 21,200 ุฌููู
โ ุงููุจูุบ ุงููุณุฏุฏ: [____] ุฌููู
โ ุงูุฑูู ุงููุฑุฌุนู: [____] (ุงุฎุชูุงุฑู)
โ ููุงุญุธุงุช: [____]

[โ ุชุฃููุฏ ุงูุณุฏุงุฏ]  [โ ุฅูุบุงุก]
```

#### 4.3 ุชูุฑูุฑ ุงูุชุณููุงุช
```
๐ ุชูุฑูุฑ ุงูุชุณููุงุช ุงููุงููุฉ - ููููุจุฑ 2024

โ ูุณุฏุฏุฉ ุจุงููุงูู: 25 ุฑุงุชุจ (530,000 ุฌููู)
โณ ูู ุงูุชุธุงุฑ ุงูุณุฏุงุฏ: 3 ุฑูุงุชุจ (63,000 ุฌููู)
๐ ุณุฏุงุฏ ุฌุฒุฆู: 1 ุฑุงุชุจ (21,000 / 25,000 ุฌููู)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ ุฅุฌูุงูู ุงููุณุชุญู: 618,000 ุฌููู
โ ุฅุฌูุงูู ุงููุณุฏุฏ: 551,000 ุฌููู
โ๏ธ ุงููุชุจูู: 67,000 ุฌููู
```

### ุฎุทุฉ ุงูุชูููุฐ:
1. ุฅูุดุงุก migration ูุฌุฏูู `HR_PayrollSettlement`
2. ุฅุถุงูุฉ enums: `SettlementStatus`, `PaymentMethod`
3. ุชุนุฏูู `savePayrollNormal()` ูุฅูุดุงุก ุณุฌู ุชุณููุฉ
4. ุฅูุดุงุก handler: `payroll-settlement.handler.ts`
5. ุฅุถุงูุฉ ูุงุฌูุฉ ุชุณุฌูู ุงูุณุฏุงุฏ
6. ุฅูุดุงุก ุชูุฑูุฑ ุงูุชุณููุงุช

---

## ๐ ุงููุฑุญูุฉ 5: ุงูุฑุจุท ุจุงูุฎุฒููุฉ (ูุณุชูุจูู)

### ุงูุงุณุชุนุฏุงุฏ ุงูุญุงูู:
- ุญูู `treasuryId` ูู ุฌุฏูู `HR_PayrollSettlement` ุฌุงูุฒ
- ุนูุงูุฉ `Treasury` ูุนุฑููุฉ ููู nullable

### ุนูุฏ ุฅูุดุงุก ูุธุงู ุงูุฎุฒููุฉ:
1. ุฅูุดุงุก ุฌุฏูู `Treasury` (ุฅุฐุง ูู ููู ููุฌูุฏุงู)
2. ุฑุจุท ุงูุชุณููุงุช ุชููุงุฆูุงู ุจูุนุงููุงุช ุงูุฎุฒููุฉ
3. ุชุญุฏูุซ ุฑุตูุฏ ุงูุฎุฒููุฉ ุนูุฏ ุงูุณุฏุงุฏ
4. ุฅููุงููุฉ ุงูุชุฑุงุฌุน ุนู ุงูุณุฏุงุฏ

---

## ๐ ุงูุฌุฏูู ุงูุฒููู ุงูููุชุฑุญ

### ุงูุฃุณุจูุน 1:
- โ ุชุญุฏูุซ ูุธุงู ุงูุฑูุงุชุจ ุงูุฃุณุงุณู (ููุชูู)
- ๐ ุชูุฑูุฑ ุงูุณุฌู ุงููุงูู ููููุธู (ููุฏ ุงูุชูููุฐ)

### ุงูุฃุณุจูุน 2:
- ุชูุฑูุฑ ุงูุนูุงู ุงูุณุงุจููู
- ูุธุงู ุงูุชุณููุงุช ุงููุงููุฉ (Schema + Migration)

### ุงูุฃุณุจูุน 3:
- ูุธุงู ุงูุชุณููุงุช ุงููุงููุฉ (UI + Handlers)
- ุงูุงุฎุชุจุงุฑ ุงูุดุงูู

### ุงูุฃุณุจูุน 4:
- ุงูุชุญุณููุงุช ูุงูุชุนุฏููุงุช
- ุงูุชูุซูู ุงูููุงุฆู

---

## ๐ฏ ุงูุฃููููุงุช

1. **ุนุงุฌู** (ุงูุฃุณุจูุน 1):
   - ุชูุฑูุฑ ุงูุณุฌู ุงููุงูู ููููุธู

2. **ููู** (ุงูุฃุณุจูุน 2):
   - ูุธุงู ุงูุชุณููุงุช ุงููุงููุฉ
   - ุชูุฑูุฑ ุงูุนูุงู ุงูุณุงุจููู

3. **ูุชูุณุท** (ุงูุฃุณุจูุน 3):
   - ุงูุชุญุณููุงุช ูุงูููุชุฑุฉ ุงููุชูุฏูุฉ
   - ุงูุฑุจุท ุงูุฃููู ุจุงูุฎุฒููุฉ

---

## ๐ ููุงุญุธุงุช ูููุฉ

### ุญุงูุฉ ุงูููุธู `SETTLED`:
- ุชุณุชุฎุฏู ููุนูุงู ุงูุฐูู **ุชูุช ุชุณููุฉ ูุณุชุญูุงุชูู ุจุงููุงูู**
- ูุฌุจ ุชุญุฏูุซูุง ุชููุงุฆูุงู ุนูุฏ:
  - ุณุฏุงุฏ ุขุฎุฑ ุฑุงุชุจ
  - ุชุณููุฉ ุฌููุน ุงููุนุงููุงุช ุงููุนููุฉ
  - ูุง ุชูุฌุฏ ุฏููู ูุชุจููุฉ

### ุชูุงูู ุงูุจูุงูุงุช:
- ุฌููุน ุงูุชูุงุฑูุฑ ุชุนุชูุฏ ุนูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ
- ูุง ุญุงุฌุฉ ูุฅุถุงูุฉ ุญููู ุฌุฏูุฏุฉ ูู ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ
- ุงูุชุฑููุฒ ุนูู aggregation ูุนุฑุถ ุงูุจูุงูุงุช

### ุงูุฃุฏุงุก:
- ุงุณุชุฎุฏุงู indexes ููุงุณุจุฉ
- ุชุฌูุจ N+1 queries
- ุงุณุชุฎุฏุงู `include` ู `select` ุจุญููุฉ

---

## ๐ ุงูุจุฏุก ูู ุงูุชูููุฐ

**ุงูุชุงูู:** ุฅูุดุงุก ุชูุฑูุฑ ุงูุณุฌู ุงููุงูู ููููุธู

```bash
# ุฅูุดุงุก ุงูููู ุงูุฌุฏูุฏ
touch src/bot/features/hr-management/handlers/payroll-financial-history.handler.ts

# ุจุฏุก ุงูุชุทููุฑ
npm run dev
```

---

**ุชู ุฅูุดุงุก ูุฐู ุงูุฎุทุฉ ูู:** 2 ููููุจุฑ 2025  
**ุขุฎุฑ ุชุญุฏูุซ:** 2 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** ููุฏ ุงูุชูููุฐ ๐
