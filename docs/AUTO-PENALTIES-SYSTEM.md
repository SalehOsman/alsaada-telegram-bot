# ูุธุงู ุงูุนููุจุงุช ุงูุชููุงุฆูุฉ
## Auto Penalties System

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ูุนูู ุชููุงุฆูุงู ููุชุญูู ูู ุงูููุธููู ุงููุชุฃุฎุฑูู ุนู ุงูุนูุฏุฉ ูู ุงูุฅุฌุงุฒุฉ ูุฅูุดุงุก ุนููุจุงุช ุชููุงุฆูุฉ ููู.

---

## โ๏ธ ููู ูุนูู ุงููุธุงูุ

### 1๏ธโฃ ุงููุฌุฏูู ุงูุชููุงุฆู (Scheduler)

- **ุงูุชุดุบูู:** ููููุงู ูู ุงูุณุงุนุฉ 9 ุตุจุงุญุงู (ุจุชูููุช ุงููุงูุฑุฉ)
- **ุงููุธููุฉ:** ุงูุชุญูู ูู ุฌููุน ุงูุฅุฌุงุฒุงุช ุงููุนุชูุฏุฉ ุงูููุชูุญุฉ

### 2๏ธโฃ ุดุฑูุท ุฅูุดุงุก ุงูุนููุจุฉ ุงูุชููุงุฆูุฉ

ูุชู ุฅูุดุงุก ุนููุจุฉ ุชููุงุฆูุงู ุฅุฐุง ุชููุฑุช **ุฌููุน** ุงูุดุฑูุท ุงูุชุงููุฉ:

โ **ุงูุฅุฌุงุฒุฉ ูุนุชูุฏุฉ** (`status: 'APPROVED'`)  
โ **ุงูุฅุฌุงุฒุฉ ูุดุทุฉ** (`isActive: true`)  
โ **ุชุงุฑูุฎ ุงูุนูุฏุฉ ุงููุชููุน ูุถู ุนููู 5 ุฃูุงู ุฃู ุฃูุซุฑ**  
โ **ูุง ููุฌุฏ ุชุงุฑูุฎ ุนูุฏุฉ ูุนูู** (`actualReturnDate: null`)  
โ **ูุง ุชูุฌุฏ ุนููุจุฉ ูุนููุฉ ุฃู ูุนุชูุฏุฉ ุจุงููุนู** ููุฅุฌุงุฒุฉ ููุณูุง  
โ **ุงูููุธู ูุดุท** (`isActive: true`)  
โ **ุงูููุธู ุบูุฑ ููููู** (`employmentStatus !== 'SUSPENDED'`)

### 3๏ธโฃ ููุน ุงูุนููุจุฉ

- ูุชู ุญุณุงุจ **ุฃูุงู ุงูุชุฃุฎูุฑ** ุชููุงุฆูุงู
- ูุชู ุงูุจุญุซ ุนู **ุณูุงุณุฉ ุงูุนููุจุฉ ุงูููุงุณุจุฉ** ูู ุฌุฏูู `HR_DelayPenaltyPolicy`
- ุญุณุจ ุงูุณูุงุณุฉ: ูุฏ ุชููู **ุฎุตู** (`DEDUCTION`) ุฃู **ุฅููุงู** (`SUSPENSION`)

---

## ๐จ ูุธุงู ุงูุฅุดุนุงุฑุงุช

### ุฅุดุนุงุฑ ููุฑู (ุนูุฏ ุฅูุดุงุก ูู ุนููุจุฉ)

ููุฑุณู ูุฌููุน ุงูุณูุจุฑ ุฃุฏููุฒ:

```
๐จ ุนููุจุฉ ุชุฃุฎูุฑ ุฌุฏูุฏุฉ

๐ค ุงูุนุงูู: [ุงุณู ุงูููุธู]
๐ข ุงูููุฏ: [ููุฏ ุงูููุธู]
โฑ๏ธ ุงูุชุฃุฎูุฑ: X ููู
๐ฐ ุงูุนููุจุฉ: ุฎุตู Y ููู / ุฅููุงู ุนู ุงูุนูู
๐ ุงูุณูุงุณุฉ: [ุงุณู ุงูุณูุงุณุฉ]

โ๏ธ ุชุญุชุงุฌ ูููุฑุงุฌุนุฉ ูุงูุงุนุชูุงุฏ

[โ๏ธ ูุฑุงุฌุนุฉ ุงูุนููุจุฉ] [๐ ุฌููุน ุงูุนููุจุงุช ุงููุนููุฉ]
```

### ููุฎุต ูููู (ุฅุฐุง ุชู ุฅูุดุงุก ุนููุจุงุช)

```
๐ค ุชูุฑูุฑ ุงูุนููุจุงุช ุงูุชููุงุฆูุฉ ุงููููู

๐ ุงูุชุงุฑูุฎ: XX/XX/XXXX
โฐ ุงูููุช: XX:XX

โ๏ธ ุชู ุฅูุดุงุก X ุนููุจุฉ ุชููุงุฆูุฉ ููููุธููู ุงููุชุฃุฎุฑูู ุนู ุงูุนูุฏุฉ ูู ุงูุฅุฌุงุฒุฉ.

๐ ุงูุนููุจุงุช ุชูุชุธุฑ ุงููุฑุงุฌุนุฉ ูุงูุงุนุชูุงุฏ.

๐ก ููุงุญุธุฉ: ูุฐู ุงูุนููุจุงุช ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ููููุธููู ุงูุฐูู ุชุฃุฎุฑูุง 5 ุฃูุงู ุฃู ุฃูุซุฑ ุนู ุงูุนูุฏุฉ ุงููุชููุนุฉ.

[โ๏ธ ูุฑุงุฌุนุฉ ุงูุนููุจุงุช ุงููุนููุฉ]
```

---

## ๐๏ธ ุงููููุงุช ุงููุนููุฉ

### 1. ุงููุฌุฏูู ุงูุฑุฆูุณู
`src/modules/schedulers/auto-penalties-scheduler.ts`

**ุงููุธุงุฆู ุงูุฃุณุงุณูุฉ:**
- `start(bot)` - ุชุดุบูู ุงููุฌุฏูู ุงููููู
- `stop()` - ุฅููุงู ุงููุฌุฏูู
- `runNow(bot?)` - ุชุดุบูู ููุฑู ููุงุฎุชุจุงุฑ
- `checkAndCreateAutoPenalties()` - ุงูููุทู ุงูุฃุณุงุณู
- `sendDailySummary()` - ุฅุฑุณุงู ุงูููุฎุต ุงููููู

### 2. ุงูุชุดุบูู ุงูุชููุงุฆู
`src/main.ts`

ุชู ุฅุถุงูุฉ:
```typescript
// Initialize Auto Penalties Scheduler
AutoPenaltiesScheduler.start(bot)
logger.info('Auto penalties scheduler initialized')
```

ูู ููุง ูุถุนู ุงูุชุดุบูู:
- **Polling mode** (ุณุทุฑ ~47)
- **Webhook mode** (ุณุทุฑ ~115)

### 3. Export Module
`src/modules/schedulers/index.ts`

```typescript
export * from './auto-penalties-scheduler.js'
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุชุดุบูู ูุฏูู ูููุฌุฏูู

```bash
npx tsx scripts/test-auto-penalties.ts
```

**ูุงุฐุง ููุนู:**
- ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูุจุญุซ ุนู ุงูุฅุฌุงุฒุงุช ุงููุชุฃุฎุฑุฉ 5+ ุฃูุงู
- ููุดุฆ ุนููุจุงุช ุชููุงุฆูุฉ
- ูุนุฑุถ ุชูุฑูุฑ ููุตู

**ููุงุญุธุฉ:** ูู ูุฑุณู ุฅุดุนุงุฑุงุช (ูุฃูู ุจุฏูู bot instance)

### ุงูุชุญูู ูู ุงูููุฌ

ุนูุฏ ุชุดุบูู ุงูุจูุช:
```
โ Auto penalties scheduler initialized
```

ุนูุฏ ุงูุชูููุฐ ุงููููู (9 ุตุจุงุญุงู):
```
๐ ุจุฏุก ุงูุชุญูู ูู ุงูุฅุฌุงุฒุงุช ุงููุชุฃุฎุฑุฉ...
๐ ุชู ุงูุนุซูุฑ ุนูู X ุฅุฌุงุฒุฉ ูุชุฃุฎุฑุฉ
๐ ุฅูุดุงุก ุนููุจุฉ ุชููุงุฆูุฉ:
   - ุงูููุธู: [ุงูุงุณู]
   - ุงูุฅุฌุงุฒุฉ: LV-XXXX
   - ุงูุชุฃุฎูุฑ: X ููู
   โ ุชู ุฅูุดุงุก ุงูุนููุจุฉ #X
โ ุงูุชูู ุงูุชุญูู - ุชู ุฅูุดุงุก X ุนููุจุฉ ุชููุงุฆูุฉ
โ ุชู ุฅุฑุณุงู ุงูููุฎุต ุงููููู ูู X ุณูุจุฑ ุฃุฏูู
```

---

## ๐ ุณูุฑ ุงูุนูู (Workflow)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูู ููู ุงูุณุงุนุฉ 9 ุตุจุงุญุงู             โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงูุจุญุซ ุนู ุฅุฌุงุฒุงุช ูุชุฃุฎุฑุฉ 5+ ุฃูุงู     โ
โ  - ูุนุชูุฏุฉ ูุจุฏูู ุชุงุฑูุฎ ุนูุฏุฉ ูุนูู      โ
โ  - ุจุฏูู ุนููุจุงุช ูุนููุฉ/ูุนุชูุฏุฉ          โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
        โโโโโโโโดโโโโโโโ
        โ   ููุฌุฏุชุ    โ
        โโโโฌโโโโโโฌโโโโโ
      ูุง   โ     โ   ูุนู
           โ     โ
           โผ     โผ
      โโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ
      โ  ุฎุฑูุฌ  โ  โ  ููู ุฅุฌุงุฒุฉ ูุชุฃุฎุฑุฉ:   โ
      โโโโโโโโโโ  โ  1. ุญุณุงุจ ุฃูุงู ุงูุชุฃุฎูุฑ โ
                  โ  2. ุงูุจุญุซ ุนู ุงูุณูุงุณุฉ  โ
                  โ  3. ุฅูุดุงุก ุงูุนููุจุฉ     โ
                  โ  4. ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฑู  โ
                  โโโโโโโโโโโโฌโโโโโโโโโโโโโโ
                             โ
                             โผ
                  โโโโโโโโโโโโโโโโโโโโโโโโ
                  โ  ุฅุฑุณุงู ููุฎุต ูููู     โ
                  โ  ูุฌููุน ุงูุณูุจุฑ ุฃุฏููุฒ  โ
                  โโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โก ุงูุชูุงูู ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู

### 1. ูุธุงู ุงูุนููุจุงุช (`DelayPenaltyService`)

- ูุณุชุฎุฏู `createPenaltyForLeave()` ูุฅูุดุงุก ุงูุนููุจุฉ
- ูููุฑุฑ `api` ูุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููุฑูุฉ

### 2. ูุธุงู ุงูุฅุดุนุงุฑุงุช (`PenaltiesNotificationsService`)

- ูุณุชุฎุฏู `notifyNewPenalty()` ุนูุฏ ุฅูุดุงุก ูู ุนููุจุฉ
- ุฅุดุนุงุฑุงุช ููุฑูุฉ ููุณูุจุฑ ุฃุฏููุฒ

### 3. ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุฌุฏุงูู:**
- `HR_EmployeeLeave` - ููุจุญุซ ุนู ุงูุฅุฌุงุฒุงุช ุงููุชุฃุฎุฑุฉ
- `HR_AppliedPenalty` - ูุฅูุดุงุก ุงูุนููุจุงุช ูุงูุชุญูู ูู ุนุฏู ุงูุชูุฑุงุฑ
- `HR_DelayPenaltyPolicy` - ููุญุตูู ุนูู ุณูุงุณุฉ ุงูุนููุจุฉ ุงูููุงุณุจุฉ
- `User` - ููุญุตูู ุนูู ุงูุณูุจุฑ ุฃุฏููุฒ

---

## ๐ง ุงูุฅุนุฏุงุฏุงุช

### ุชุบููุฑ ููุนุฏ ุงูุชุดุบูู

ูู `auto-penalties-scheduler.ts`:

```typescript
// ุงูุชุดุบูู ููููุงู ูู ุงูุณุงุนุฉ 9 ุตุจุงุญุงู
this.task = cron.schedule(
  '0 9 * * *',  // โ ุบููุฑ ููุง
  // ...
)
```

**ุตูุบุฉ Cron:**
- `'0 9 * * *'` = 9 ุตุจุงุญุงู ููููุงู
- `'0 */6 * * *'` = ูู 6 ุณุงุนุงุช
- `'0 0 * * *'` = ููุชุตู ุงูููู ููููุงู

### ุชุบููุฑ ุงูุญุฏ ุงูุฃุฏูู ููุชุฃุฎูุฑ

ุญุงููุงู: **5 ุฃูุงู**

ูู `auto-penalties-scheduler.ts` (ุณุทุฑ ~74):

```typescript
// ุญุณุงุจ ุชุงุฑูุฎ 5 ุฃูุงู ูุถุช
const fiveDaysAgo = new Date(today)
fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5)  // โ ุบููุฑ ุงูุฑูู
```

### ุงููุณุชุฎุฏู ุงููููุดุฆ ููุนููุจุงุช

ุญุงููุงู: `employeeId = 1` (ุงููุธุงู)

ูู `auto-penalties-scheduler.ts` (ุณุทุฑ ~151):

```typescript
const systemUserId = BigInt(1)  // โ ID ุงููุณุชุฎุฏู
```

---

## ๐ก๏ธ ุงูุฃูุงู ูุงูุงุณุชูุฑุงุฑ

### ููุน ุงูุชูููุฐ ุงููุชุฒุงูู

```typescript
if (this.isRunning) {
  console.log('โ๏ธ Auto penalties check is already running, skipping...')
  return
}
this.isRunning = true
```

### ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

- `try/catch` ุนูู ูุณุชูู ูู ุฅุฌุงุฒุฉ ูููุฑุฏุฉ
- ุงูุฃุฎุทุงุก ูุง ุชููู ุงููุนุงูุฌุฉ ููุฅุฌุงุฒุงุช ุงูุฃุฎุฑู
- ุชุณุฌูู ุชูุตููู ูู ุงูู console

### ุงูุชุญูู ูู ุงูุดุฑูุท

- ุชุฎุทู ุงูููุธููู ุบูุฑ ุงููุดุทูู
- ุชุฎุทู ุงูููุธููู ุงูููููููู
- ุนุฏู ุฅูุดุงุก ุนููุจุฉ ููุฑุฑุฉ

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ูุงููุฑุงูุจุฉ

### Console Logs

```bash
โ Auto penalties scheduler initialized
๐ ุจุฏุก ุงูุชุญูู ูู ุงูุฅุฌุงุฒุงุช ุงููุชุฃุฎุฑุฉ...
๐ ุชู ุงูุนุซูุฑ ุนูู 3 ุฅุฌุงุฒุฉ ูุชุฃุฎุฑุฉ
๐ ุฅูุดุงุก ุนููุจุฉ ุชููุงุฆูุฉ:
   - ุงูููุธู: ุฃุญูุฏ ูุญูุฏ
   - ุงูุฅุฌุงุฒุฉ: LV-2025-051
   - ุงูุชุฃุฎูุฑ: 7 ููู
   โ ุชู ุฅูุดุงุก ุงูุนููุจุฉ #42
โญ๏ธ ุชุฎุทู ูุญูุฏ ุนูู - ููููู ุจุงููุนู
โ ุงูุชูู ุงูุชุญูู - ุชู ุฅูุดุงุก 2 ุนููุจุฉ ุชููุงุฆูุฉ
โ ุชู ุฅุฑุณุงู ุงูููุฎุต ุงููููู ูู 3 ุณูุจุฑ ุฃุฏูู
```

---

## โ ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

### ุณ: ูุชู ูุชู ุฅูุดุงุก ุงูุนููุจุฉุ
**ุฌ:** ููููุงู ุงูุณุงุนุฉ 9 ุตุจุงุญุงูุ ุจุนุฏ ูุฑูุฑ 5 ุฃูุงู ุฃู ุฃูุซุฑ ุนูู ุชุงุฑูุฎ ุงูุนูุฏุฉ ุงููุชููุน.

### ุณ: ูุงุฐุง ูู ุณุฌูู ุงูุฃุฏูู ุงูุนูุฏุฉ ูุจู 5 ุฃูุงูุ
**ุฌ:** ุฅุฐุง ุชู ุชุณุฌูู ุงูุนูุฏุฉ ุจุชุฃุฎูุฑ ุฃูู ูู 5 ุฃูุงูุ ุณูุชู ุฅูุดุงุก ุงูุนููุจุฉ ููุฑุงู ุญุณุจ ุงูุณูุงุณุฉ ุงููุนููู ุจูุง.

### ุณ: ูุงุฐุง ูู ุณุฌูู ุงูุฃุฏูู ุงูุนูุฏุฉ ุจุนุฏ ุฅูุดุงุก ุงูุนููุจุฉ ุงูุชููุงุฆูุฉุ
**ุฌ:** ุงูุนููุจุฉ ุณุชุจูู ูุนููุฉ ูููุฑุงุฌุนุฉุ ููููู ููุณูุจุฑ ุฃุฏูู ุงุนุชูุงุฏูุง ุฃู ุฅูุบุงุคูุง.

### ุณ: ูู ูููู ุฅูุดุงุก ุนููุจุชูู ูููุณ ุงูุฅุฌุงุฒุฉุ
**ุฌ:** ูุงุ ุงููุธุงู ูุชุญูู ูู ุนุฏู ูุฌูุฏ ุนููุจุฉ ูุนููุฉ/ูุนุชูุฏุฉ ูุจู ุงูุฅูุดุงุก.

### ุณ: ูุงุฐุง ุนู ุงูููุธููู ุงููููููููุ
**ุฌ:** ูุชู ุชุฎุทููู ุชููุงุฆูุงู ูุฃููู ููููููู ุจุงููุนู.

### ุณ: ููู ุฃุฎุชุจุฑ ุงููุธุงูุ
**ุฌ:** 
```bash
npx tsx scripts/test-auto-penalties.ts
```

### ุณ: ููู ุฃููู ุงููุฌุฏูู ูุคูุชุงูุ
**ุฌ:** ูู ุงูููุฏ:
```typescript
AutoPenaltiesScheduler.stop()
```

---

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ ุงูููุชุฑุญุฉ

- [ ] ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช ูุงุจูุฉ ููุชุฎุตูุต ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููููุธููู ูุจู ุฅูุดุงุก ุงูุนููุจุฉ
- [ ] ุชูุงุฑูุฑ ุดูุฑูุฉ ุนู ุงูุนููุจุงุช ุงูุชููุงุฆูุฉ
- [ ] ูุงุฌูุฉ ุฅุฏุงุฑุฉ ูููุฌุฏูู ูู ุฏุงุฎู ุงูุจูุช
- [ ] ุชุฏุฑุฌ ูู ุงูุนููุจุงุช (ุชุญุฐูุฑ โ ุฎุตู โ ุฅููุงู)

---

## ๐ ุงูุฏุนู

ูููุดุงูู ุฃู ุงูุงุณุชูุณุงุฑุงุช:
1. ุชุญูู ูู ุงูู console logs
2. ุฑุงุฌุน ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุฌุฏูู `HR_AppliedPenalty`)
3. ุฌุฑูุจ ุงูุณูุฑูุจุช ุงููุฏูู ููุงุฎุชุจุงุฑ
4. ุฑุงุฌุน ูุฐุง ุงูููู ููุชูุซูู ุงููุงูู
