# ๐ง ุชุญุฏูุซุงุช ูุธุงู ุงูุฑูุงุชุจ - ููููุจุฑ 2025

## ๐ ุงูููุฎุต

ุชู ุฅุตูุงุญ ูุดููุชูู ุญุฑุฌุชูู ูู ูุธุงู ุงูุฑูุงุชุจ ูุฅุถุงูุฉ ุชุญุณููุงุช ูููุฉ:

### โ ุงููุดุงูู ุงูููุตูุญุฉ

1. **๐ ูุดููุฉ ุชูุฑุงุฑ ุงูุฏููู ุงูุณุงุจูุฉ**
   - ุงูุณุจุจ: ุงูุฏููู ุงููุฏููุฉ ูู ุชูู ุชูุณูู ุนูุฏ ุญุณุงุจ ุงูุฑุงุชุจ
   - ุงููุชูุฌุฉ: ุธููุฑ ููุณ ุงูุฏูู ูู ุนุฏุฉ ุฃุดูุฑ ูุชุชุงููุฉ
   - ุงูุญู: ุฅุถุงูุฉ ุชุณููุฉ ุงูุฏููู ูู ุฏุงูุฉ `savePayrollWithDebt()`

2. **๐ ูุดููุฉ ุชูุฑูุฑ Excel ูุง ููุธูุฑ ุงูุชูุงุตูู**
   - ุงูุณุจุจ: Excel ูุงู ูุนุฑุถ ุงูุฅุฌูุงููุงุช ููุท ุฏูู ุงูุชูุงุตูู
   - ุงููุชูุฌุฉ: ุนุฏู ุธููุฑ ุฃุณูุงุก ุงูุจุฏูุงุช ูุงูููุงูุขุช
   - ุงูุญู: ุฅุถุงูุฉ 3 ุตูุญุงุช ุชูุตูููุฉ ูู ููู Excel

---

## ๐ง ุงูุชุบููุฑุงุช ุงูุชูููุฉ

### 1. ุฅุตูุงุญ ุชุณููุฉ ุงูุฏููู

**ุงูููู:** `src/bot/features/hr-management/handlers/payroll-calculate.handler.ts`

**ูุจู ุงูุฅุตูุงุญ:**
```typescript
// ูู ุฏุงูุฉ savePayrollWithDebt() - ุงูุณุทุฑ 1185
await Database.prisma.hR_Transaction.updateMany({
  where: {
    OR: [
      { transactionType: 'CASH_ADVANCE', status: 'APPROVED' },
      { transactionType: 'ITEM_WITHDRAWAL', status: 'APPROVED' },
      // โ ุงูุฏููู ุงููุฏููุฉ ูู ุชูู ููุฏุฑุฌุฉ
    ],
  },
  data: { isSettled: true, settledAt: new Date() },
})
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```typescript
// ูู ุฏุงูุฉ savePayrollWithDebt() - ุงูุณุทุฑ 1223
await Database.prisma.hR_Transaction.updateMany({
  where: {
    OR: [
      { transactionType: 'CASH_ADVANCE', status: 'APPROVED' },
      { transactionType: 'ITEM_WITHDRAWAL', status: 'APPROVED' },
      { transactionType: 'EMPLOYEE_DEBT', status: 'PENDING' }, // โ ุชูุช ุงูุฅุถุงูุฉ
    ],
  },
  data: { isSettled: true, settledAt: new Date() },
})
```

**ุงูุชุฃุซูุฑ:**
- โ ุงูุฏููู ุงูุณุงุจูุฉ ุชูุณูู ุชููุงุฆูุงู ุนูุฏ ุญุณุงุจ ุงูุฑุงุชุจ
- โ ููุน ุชูุฑุงุฑ ุงูุฏููู ูู ุงูุฃุดูุฑ ุงูุชุงููุฉ
- โ ุฏูุฉ ูู ุญุณุงุจ ุงูุฎุตููุงุช ุงูุดูุฑูุฉ

---

### 2. ุชุญุณูู ุชูุฑูุฑ Excel

**ุงูููู:** `src/bot/features/hr-management/handlers/payroll-financial-history.handler.ts`

**ูุจู ุงูุชุญุณูู:**
- ุตูุญุฉ ูุงุญุฏุฉ ููุท: "ุงูููุฎุต ุงููุงูู"
- ุนุฑุถ ุงูุฅุฌูุงููุงุช ููุท
- ูุง ุชูุฌุฏ ุชูุงุตูู ููุจุฏูุงุช ูุงูููุงูุขุช

**ุจุนุฏ ุงูุชุญุณูู:**
```
๐ ููู Excel ุงูุฌุฏูุฏ ูุญุชูู ุนูู 4 ุตูุญุงุช:

1๏ธโฃ ุงูููุฎุต ุงููุงูู (Summary)
   - ูุนูููุงุช ุงูููุธู
   - ุฅุฌูุงูู ุงููุชุฑุฉ
   - ุฌุฏูู ุดูุฑู ุจุงูุฅุฌูุงููุงุช

2๏ธโฃ ุชูุงุตูู ุงูุจุฏูุงุช (Allowances Details)
   - ุงูุดูุฑ
   - ููุน ุงูุจุฏู (ูุธููุฉ / ุดุฎุตู / ูุณุชูุฒูุงุช)
   - ุงุณู ุงูุจุฏู
   - ุงููุจูุบ

3๏ธโฃ ุชูุงุตูู ุงูููุงูุขุช (Bonuses Details)
   - ุงูุดูุฑ
   - ููุน ุงูููุงูุฃุฉ (ููููุฉ / ุดูุฑูุฉ / ุซุงุจุชุฉ)
   - ุงุณู ุงูููุงูุฃุฉ
   - ุงููุจูุบ

4๏ธโฃ ุชูุงุตูู ุงูุฎุตููุงุช (Deductions Details)
   - ุงูุดูุฑ
   - ููุน ุงูุฎุตู (ุณููุฉ / ูุณุญูุจุงุช / ุฏูู ุณุงุจู)
   - ุงููุตู
   - ุงูุชุงุฑูุฎ
   - ุงููุจูุบ
```

**ูุซุงู ุนูู ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ ุงูุขู:**

| ุงูุดูุฑ | ููุน ุงูุจุฏู | ุงุณู ุงูุจุฏู | ุงููุจูุบ |
|-------|-----------|-----------|--------|
| ููููุจุฑ 2025 | ุจุฏู ูุธููุฉ | ุจุฏู ููุงุตูุงุช | 150.00 |
| ููููุจุฑ 2025 | ุจุฏู ุดุฎุตู | ุจุฏู ุฅูุงูุฉ | 200.00 |
| ููููุจุฑ 2025 | ุจุฏู ูุณุชูุฒูุงุช | ุจุฏู ุงููุณุญูุจุงุช ุงูุนูููุฉ | 50.00 |

**ุงูุชุฃุซูุฑ:**
- โ ุดูุงููุฉ ูุงููุฉ ูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ
- โ ุฅููุงููุฉ ุชุชุจุน ูู ุจุฏู ูููุงูุฃุฉ ุจุงูุชูุตูู
- โ ุณูููุฉ ุงููุฑุงุฌุนุฉ ุงููุญุงุณุจูุฉ

---

### 3. ุฅุถุงูุฉ Validation ูููุน ุงูุฏููู ุงูููุฑุฑุฉ

**ุงูููู:** `src/bot/features/hr-management/handlers/payroll-calculate.handler.ts`

**ุงูููุฏ ุงูุฌุฏูุฏ:** (ุงูุณุทุฑ 1124-1153)
```typescript
// ูู ุฏุงูุฉ savePayrollWithDebt()
// 0๏ธโฃ ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฏูู ุบูุฑ ููุณูู ูููุณ ุงูููุธู ูู ููุณ ุงูุดูุฑ
const existingDebt = await Database.prisma.hR_Transaction.findFirst({
  where: {
    employeeId: payrollData.employeeId,
    transactionType: 'EMPLOYEE_DEBT',
    isSettled: false,
    status: 'PENDING',
    createdAt: { gte: startOfMonth, lte: endOfMonth },
  },
})

if (existingDebt) {
  // ุนุฑุถ ุฑุณุงูุฉ ุชุญุฐูุฑ ูููุน ุฅูุดุงุก ุฏูู ุฌุฏูุฏ
  await ctx.editMessageText('โ๏ธ ุชุญุฐูุฑ: ุฏูู ููุฌูุฏ ูุณุจูุงู...')
  return
}
```

**ุงูุชุฃุซูุฑ:**
- โ ููุน ุฅูุดุงุก ุฏููู ููุฑุฑุฉ ูู ุงูุฃุณุงุณ
- โ ุชูุจูู ุงููุณุชุฎุฏู ููุฌูุฏ ุฏูู ุบูุฑ ููุณูู
- โ ุญูุงูุฉ ูู ุงูุฃุฎุทุงุก ุงูุจุดุฑูุฉ

---

## ๐งน ุณูุฑูุจุช ุชูุธูู ุงูุฏููู ุงูููุฑุฑุฉ

**ุงูููู:** `scripts/cleanup-duplicate-debts.ts`

### ุงููุธููุฉ
ุณูุฑูุจุช ุขูู ููุจุญุซ ุนู ูุชูุธูู ุงูุฏููู ุงูููุฑุฑุฉ ุงูููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

### ููููุฉ ุงูุงุณุชุฎุฏุงู

#### 1. ูุนุงููุฉ ุงูุฏููู ุงูููุฑุฑุฉ (ุจุฏูู ุชุนุฏูู):
```bash
npx tsx scripts/cleanup-duplicate-debts.ts
```

**ุงููุชูุฌุฉ:**
```
๐ ุงูุจุญุซ ุนู ุงูุฏููู ุงูููุฑุฑุฉ...

๐ ุฅุฌูุงูู ุงูุฏููู ุบูุฑ ุงููุณูุงุฉ: 8
โ๏ธ  ุนุฏุฏ ูุฌููุนุงุช ุงูุฏููู ุงูููุฑุฑุฉ: 2

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุชูุงุตูู ุงูุฏููู ุงูููุฑุฑุฉ:

๐ค ุตุงูุญ ุฑุฌุจ ูุญูุฏ ุนุซูุงู (001)
   ุงููุจูุบ: 106.67 ุฌููู
   ุนุฏุฏ ุงูุชูุฑุงุฑุงุช: 2
   ุงูุชูุงุฑูุฎ:
   โโ ๐๏ธ  1/11/2025 (ID: 42) - ุณูุชู ุชุณููุชู
   โโ โ 2/11/2025 (ID: 45) - ุณูุชู ุงูุงุญุชูุงุธ ุจู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุงูููุฎุต:
   - ุนุฏุฏ ุงูููุธููู ุงููุชุฃุซุฑูู: 1
   - ุฅุฌูุงูู ุงูุฏููู ููุชุณููุฉ: 1
   - ุงููุถุน: ๐ ูุนุงููุฉ ููุท (ูู ูุชู ุงูุชุนุฏูู)

โ๏ธ  ูุฐู ูุนุงููุฉ ููุท. ูู ูุชู ุชุนุฏูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
   ูุชูููุฐ ุงูุชูุธูู ุงููุนููุ ูู ุจุชุดุบูู ุงูุณูุฑูุจุช ูุน ุงููุนุงูู --execute:

   npx tsx scripts/cleanup-duplicate-debts.ts --execute
```

#### 2. ุชูููุฐ ุงูุชูุธูู ุงููุนูู:
```bash
npx tsx scripts/cleanup-duplicate-debts.ts --execute
```

**ูุง ูุญุฏุซ:**
- โ ูุจุญุซ ุนู ุงูุฏููู ุงูููุฑุฑุฉ (ููุณ ุงูููุธูุ ููุณ ุงููุจูุบ)
- โ ูุญุชูุธ ุจุฃุญุฏุซ ุฏูู ููุท
- โ ููุณูู ุงูุฏููู ุงููุฏููุฉ ุงูููุฑุฑุฉ ุชููุงุฆูุงู
- โ ูุถูู ููุงุญุธุฉ "[ุชู ุงูุชุณููุฉ ุชููุงุฆูุงู - ุฏูู ููุฑุฑ]"

**โ๏ธ ุชุญุฐูุฑ ููู:**
- ุชุฃูุฏ ูู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจู ุงูุชูููุฐ
- ุฑุงุฌุน ุงููุนุงููุฉ ุฌูุฏุงู ูุจู ุงูุชูููุฐ ุงููุนูู
- ูุง ูููู ุงูุชุฑุงุฌุน ุนู ุงูุชุบููุฑุงุช ุจุนุฏ ุงูุชูููุฐ

---

## ๐ ูููู ุงูุจูุงูุงุช

### ุญููู HR_PayrollRecord
```typescript
{
  // ... ุญููู ุฃุฎุฑู
  allowancesDetails: Json  // ูุตูููุฉ ูู:
    [
      { type: 'position', name: 'ุจุฏู ููุงุตูุงุช', amount: 150.00 },
      { type: 'employee', name: 'ุจุฏู ุฅูุงูุฉ', amount: 200.00 },
      { type: 'material', name: 'ุจุฏู ุงููุณุญูุจุงุช ุงูุนูููุฉ', amount: 50.00 }
    ]
  
  bonusesDetails: Json  // ูุตูููุฉ ูู:
    [
      { name: 'ููุงูุฃุฉ ุชููุฒ', type: 'MONTHLY', amount: 300.00 },
      { name: 'ุญุงูุฒ ุฅูุชุงุฌ', type: 'DAILY', amount: 150.00 }
    ]
  
  deductionsDetails: Json  // ูุตูููุฉ ูู:
    [
      { type: 'CASH_ADVANCE', amount: 500.00, date: '...', description: '...' },
      { type: 'ITEM_WITHDRAWAL', amount: 100.00, date: '...', itemName: '...' },
      { type: 'EMPLOYEE_DEBT', amount: 106.67, date: '...', description: '...' }
    ]
}
```

---

## ๐ฏ ุงูุฎุทูุงุช ุงูููุชุฑุญุฉ ููุชูููุฐ

### 1. ูุณุฎ ุงุญุชูุงุทู ููุงุนุฏุฉ ุงูุจูุงูุงุช
```bash
# ูุณุฎ ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
cp prisma/dev.db prisma/dev.db.backup-$(date +%Y%m%d)
```

### 2. ุฅุนุงุฏุฉ ุจูุงุก ุงูููุฏ
```bash
npm run build
```

### 3. ูุนุงููุฉ ุงูุฏููู ุงูููุฑุฑุฉ
```bash
npx tsx scripts/cleanup-duplicate-debts.ts
```

### 4. ุชูุธูู ุงูุฏููู ุงูููุฑุฑุฉ (ุฅุฐุง ููุฌุฏุช)
```bash
npx tsx scripts/cleanup-duplicate-debts.ts --execute
```

### 5. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุจูุช
```bash
npm start
```

---

## โ ุงูุชุญูู ูู ูุฌุงุญ ุงูุฅุตูุงุญ

### 1. ุงุฎุชุจุงุฑ ุชุณููุฉ ุงูุฏููู
- [ ] ุงุญุณุจ ุฑุงุชุจ ููุธู ูุฏูู ุฏูู ุณุงุจู
- [ ] ุชุญูู ุฃู ุงูุฏูู ุงููุฏูู ููุฏุฑุฌ ูู ุงูุฎุตููุงุช
- [ ] ุงุญูุธ ุงูุฑุงุชุจ
- [ ] ุชุญูู ุฃู ุงูุฏูู ุงููุฏูู ุฃุตุจุญ `isSettled: true`
- [ ] ุงุญุณุจ ุฑุงุชุจ ุงูุดูุฑ ุงูุชุงูู
- [ ] ุชุญูู ุฃู ุงูุฏูู ุงููุฏูู **ูุง ูุธูุฑ ูุฑุฉ ุฃุฎุฑู**

### 2. ุงุฎุชุจุงุฑ ุชูุฑูุฑ Excel
- [ ] ุงูุชุญ ุชูุฑูุฑ ูุงูู ูููุธู
- [ ] ุงุถุบุท "๐ ุชุตุฏูุฑ Excel"
- [ ] ุงูุชุญ ููู Excel
- [ ] ุชุญูู ูู ูุฌูุฏ 4 ุตูุญุงุช
- [ ] ุชุญูู ูู ุตูุญุฉ "ุชูุงุตูู ุงูุจุฏูุงุช" ุชุนุฑุถ ุฃุณูุงุก ุงูุจุฏูุงุช
- [ ] ุชุญูู ูู ุตูุญุฉ "ุชูุงุตูู ุงูููุงูุขุช" ุชุนุฑุถ ุฃุณูุงุก ุงูููุงูุขุช
- [ ] ุชุญูู ูู ุตูุญุฉ "ุชูุงุตูู ุงูุฎุตููุงุช" ุชุนุฑุถ ุงูุชูุงุฑูุฎ ูุงูุฃูุตุงู

### 3. ุงุฎุชุจุงุฑ ููุน ุงูุฏููู ุงูููุฑุฑุฉ
- [ ] ุงุญุณุจ ุฑุงุชุจ ููุธู ุจุตุงูู ุณุงูุจ (ููุดุฆ ุฏูู)
- [ ] ุงุญูุธ ุงูุฑุงุชุจ
- [ ] ุญุงูู ุญุณุงุจ ููุณ ุงูุฑุงุชุจ ูุฑุฉ ุฃุฎุฑู
- [ ] ูุฌุจ ุฃู ูุธูุฑ ุชุญุฐูุฑ ูููุน ุฅูุดุงุก ุฏูู ุฌุฏูุฏ

---

## ๐ ุงุณุชุนูุงูุงุช ูููุฏุฉ ููุชุญูู

### 1. ุนุฑุถ ุงูุฏููู ุบูุฑ ุงููุณูุงุฉ
```sql
SELECT 
  e.employeeCode,
  e.nickname,
  t.amount,
  t.createdAt,
  t.notes
FROM HR_Transaction t
JOIN Employee e ON t.employeeId = e.id
WHERE t.transactionType = 'EMPLOYEE_DEBT'
  AND t.isSettled = false
ORDER BY e.employeeCode, t.createdAt;
```

### 2. ุนุฑุถ ุณุฌูุงุช ุงูุฑูุงุชุจ ูุน ุงูุชูุงุตูู
```sql
SELECT 
  employeeCode,
  employeeName,
  month,
  year,
  json_extract(allowancesDetails, '$') as allowances,
  json_extract(bonusesDetails, '$') as bonuses,
  json_extract(deductionsDetails, '$') as deductions
FROM HR_PayrollRecord
WHERE employeeId = 1
ORDER BY year DESC, month DESC;
```

### 3. ุฅุญุตุงุฆูุงุช ุงูุฏููู
```sql
SELECT 
  COUNT(*) as total_debts,
  SUM(amount) as total_amount,
  COUNT(CASE WHEN isSettled = true THEN 1 END) as settled_count,
  COUNT(CASE WHEN isSettled = false THEN 1 END) as pending_count
FROM HR_Transaction
WHERE transactionType = 'EMPLOYEE_DEBT';
```

---

## ๐ ุงููููุงุช ุงูููุนุฏูุฉ

### ูููุงุช ุงูููุฏ
- โ `src/bot/features/hr-management/handlers/payroll-calculate.handler.ts`
  - ุฅุตูุงุญ ุชุณููุฉ ุงูุฏููู (ุงูุณุทุฑ 1223)
  - ุฅุถุงูุฉ validation (ุงูุณุทุฑ 1124-1153)

- โ `src/bot/features/hr-management/handlers/payroll-financial-history.handler.ts`
  - ุชุญุณูู ุฏุงูุฉ exportPayrollToExcel (ุงูุณุทุฑ 889-1220)
  - ุฅุถุงูุฉ 3 ุตูุญุงุช ุชูุตูููุฉ

### ุณูุฑูุจุชุงุช ุฌุฏูุฏุฉ
- โ `scripts/cleanup-duplicate-debts.ts`
  - ุณูุฑูุจุช ุชูุธูู ุงูุฏููู ุงูููุฑุฑุฉ

### ูููุงุช ุงูุชูุซูู
- โ `docs/PAYROLL-FIXES-SUMMARY.md` (ูุฐุง ุงูููู)

---

## ๐ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ูุจู ุงูุฅุตูุงุญ:
```
ููููุจุฑ 2025:
โ ๐ด ุฏูู ุณุงุจู - ุฏูู ูู ุฑุงุชุจ ุฃูุชูุจุฑ 2025 (1/11/2025): 106.67 ุฌ
โ ๐ด ุฏูู ุณุงุจู - ุฏูู ูู ุฑุงุชุจ ุฃูุชูุจุฑ 2025 (2/11/2025): 106.67 ุฌ
โ๏ธ ุฅุฌูุงูู ุงูุฎุตููุงุช: 213.33 ุฌููู  โ ุฎุทุฃ!
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
ููููุจุฑ 2025:
โ ๐ด ุฏูู ุณุงุจู - ุฏูู ูู ุฑุงุชุจ ุฃูุชูุจุฑ 2025 (1/11/2025): 106.67 ุฌ
โ๏ธ ุฅุฌูุงูู ุงูุฎุตููุงุช: 106.67 ุฌููู  โ ุตุญูุญ!

ุฏูุณูุจุฑ 2025:
(ูุง ููุฌุฏ ุฏูู ุณุงุจู - ุชู ุชุณููุชู ูู ููููุจุฑ)  โ
```

---

## ๐ ุงูุฏุนู ุงูููู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุฑุงุฌุน ุงูุฎุทูุงุช ูู ูุณู "๐ฏ ุงูุฎุทูุงุช ุงูููุชุฑุญุฉ ููุชูููุฐ"
2. ุชุฃูุฏ ูู ูุฌูุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
3. ุฑุงุฌุน ุงูุงุณุชุนูุงูุงุช ูู ูุณู "๐ ุงุณุชุนูุงูุงุช ูููุฏุฉ ููุชุญูู"
4. ุชุญูู ูู logs ุงูุจูุช ูุฑุณุงุฆู ุงูุฃุฎุทุงุก

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 2 ููููุจุฑ 2025  
**ุงูุฅุตุฏุงุฑ:** 2.0.0  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชุทุจูู
