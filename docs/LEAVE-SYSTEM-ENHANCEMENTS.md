# ุชุญุณููุงุช ูุธุงู ุงูุฅุฌุงุฒุงุช - Leave System Enhancements

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุฌุฑุงุก ุชุญุณููุงุช ุดุงููุฉ ุนูู ูุธุงู ุงูุฅุฌุงุฒุงุช ูุญู ุงููุดุงูู ุงูููุทููุฉ ูุฅุถุงูุฉ ูุธุงุฆู ุฌุฏูุฏุฉ.

---

## โ ุงูุชุญุฏูุซุงุช ุงููููุฐุฉ

### 1๏ธโฃ ุชุตููุฉ ุงูุนุงูููู ูู ุชุณุฌูู ุฅุฌุงุฒุฉ ุฌุฏูุฏุฉ
**ุงูููู ุงููุนุฏู:** `src/bot/features/hr-management/handlers/leaves-add.handler.ts`

#### ุงูุชุบููุฑุงุช:
- โ **ุงุณุชุจุนุงุฏ ุงูุนุงูููู ุงูุฐูู ูุฏููู ุฅุฌุงุฒุงุช ูุนููุฉ** (ูู ูุชู ุชุณุฌูู ุนูุฏุชูู)
- โ ุชุญุฏูุซ ุงุณุชุนูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ููุถุนูู (ุณุทุฑ 38 ูุณุทุฑ 107)

#### ุงูุงุณุชุนูุงู ุงูุฌุฏูุฏ:
```typescript
const employees = await prisma.employee.findMany({
  where: {
    isActive: true,
    employmentStatus: 'ACTIVE',
    // โ ุงุณุชุจุนุงุฏ ุงูุนุงูููู ุงูุฐูู ูุฏููู ุฅุฌุงุฒุฉ ูุนููุฉ
    NOT: {
      leaves: {
        some: {
          actualReturnDate: null, // ุฅุฌุงุฒุฉ ูุนููุฉ = ูู ูุชู ุชุณุฌูู ุงูุนูุฏุฉ
          status: {
            in: ['PENDING', 'APPROVED'],
          },
        },
      },
    },
  },
  // ...
})
```

#### ุงููุชุงุฆุฌ:
- ๐ซ ูู ูุธูุฑ ุงูุนุงูููู ูู ูุงุฆูุฉ "ุชุณุฌูู ุฅุฌุงุฒุฉ ุฌุฏูุฏุฉ" ุฅุฐุง ูุงููุง ูู ุฅุฌุงุฒุฉ ูุนููุฉ
- โ ูููุน ุชุณุฌูู ุฅุฌุงุฒุงุช ูุชุฏุงุฎูุฉ
- ๐ ุฑุณุงูุฉ ุชูุถูุญูุฉ ุนูุฏ ุนุฏู ูุฌูุฏ ุนุงูููู ูุชุงุญูู

---

### 2๏ธโฃ ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงูุชุนุฏูู ูุงูุญุฐู
**ุงูููู ุงููุนุฏู:** `src/bot/features/hr-management/handlers/leaves-list.handler.ts`

#### ุงูุชุบููุฑุงุช:
- โ๏ธ ุฅุถุงูุฉ ุฒุฑ "ุชุนุฏูู" ูุชูุงุตูู ุงูุฅุฌุงุฒุฉ
- ๐๏ธ ุฅุถุงูุฉ ุฒุฑ "ุญุฐู" ูุชูุงุตูู ุงูุฅุฌุงุฒุฉ

#### ุงูุฃุฒุฑุงุฑ ุงูุฌุฏูุฏุฉ:
```typescript
const keyboard = new InlineKeyboard()
  .text('โ๏ธ ุชุนุฏูู', `leaves:edit:${leaveId}`)
  .text('๐๏ธ ุญุฐู', `leaves:delete:confirm:${leaveId}`)
  .row()
  .text('โฌ๏ธ ุฑุฌูุน ูููุงุฆูุฉ', 'leaves:list')
  .row()
  .text('๐ ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ', 'leavesHandler')
```

---

### 3๏ธโฃ ูุธุงู ุชุนุฏูู ุงูุฅุฌุงุฒุงุช ุงููุงูู
**ุงูููู ุงูุฌุฏูุฏ:** `src/bot/features/hr-management/handlers/leaves-edit.handler.ts`

#### ุงููุธุงุฆู ุงููุชุงุญุฉ:

##### ๐ ุชุนุฏูู ุชุงุฑูุฎ ุงูุจุฏุงูุฉ
- ุงุฎุชูุงุฑ ุชุงุฑูุฎ ุฌุฏูุฏ ูู ุงูุชูููู (7 ุฃูุงู)
- ุงูุชุญูู ูู ุฃู ุชุงุฑูุฎ ุงูุจุฏุงูุฉ โค ุชุงุฑูุฎ ุงูููุงูุฉ
- ุฅุนุงุฏุฉ ุญุณุงุจ ุนุฏุฏ ุงูุฃูุงู ุชููุงุฆููุง

##### ๐ ุชุนุฏูู ุชุงุฑูุฎ ุงูููุงูุฉ
- ุงุฎุชูุงุฑ ุชุงุฑูุฎ ุฌุฏูุฏ ูู ุงูุชูููู
- ุงูุชุญูู ูู ุฃู ุชุงุฑูุฎ ุงูููุงูุฉ โฅ ุชุงุฑูุฎ ุงูุจุฏุงูุฉ
- ุฅุนุงุฏุฉ ุญุณุงุจ ุนุฏุฏ ุงูุฃูุงู ุชููุงุฆููุง

##### ๐ ุชุนุฏูู ููุน ุงูุฅุฌุงุฒุฉ
- ุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ:
  * ๐ ุงุนุชูุงุฏูุฉ (REGULAR)
  * ๐ฅ ูุฑุถูุฉ (SICK)
  * โก ุนุงุฑุถุฉ (EMERGENCY)
  * ๐ฐ ุจุฏูู ูุฑุชุจ (UNPAID)

##### ๐ฌ ุชุนุฏูู ุงูููุงุญุธุงุช
- ุฅุถุงูุฉ/ุชุนุฏูู ููุงุญุธุงุช ูุตูุฉ
- ุญุฐู ุงูููุงุญุธุงุช (ูุชุงุจุฉ "ุญุฐู")

#### ุงููููุฏ ุงูุฃูููุฉ:
```typescript
// โ๏ธ ูุง ูููู ุชุนุฏูู ุฅุฌุงุฒุฉ ุชู ุชุณุฌูู ุนูุฏุชูุง
if (leave.actualReturnDate) {
  await ctx.editMessageText(
    'โ๏ธ ูุง ูููู ุชุนุฏูู ุฅุฌุงุฒุฉ ุชู ุชุณุฌูู ุนูุฏุฉ ุงูุนุงูู ูููุง.\n\n'
    + `๐ ุชุงุฑูุฎ ุงูุนูุฏุฉ ุงููุณุฌู: ${Calendar.formatArabic(leave.actualReturnDate)}`
  )
  return
}
```

#### ุงููููุฒุงุช:
- โ ูุงุฌูุฉ ููุงุฆู ูุชุนุฏุฏุฉ ุงูุฎุทูุงุช
- โ ุชุฎุฒูู ูุคูุช ููุญุงูุฉ (session management)
- โ ุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
- โ ุฅุนุงุฏุฉ ุญุณุงุจ ุชููุงุฆูุฉ ููุฃูุงู
- โ ุฑุณุงุฆู ูุฌุงุญ/ูุดู ูุงุถุญุฉ

---

### 4๏ธโฃ ูุธุงู ุญุฐู ุงูุฅุฌุงุฒุงุช (Soft Delete)
**ุงูููู ุงูุฌุฏูุฏ:** `src/bot/features/hr-management/handlers/leaves-delete.handler.ts`

#### ุณูุฑ ุงูุนูู:

##### 1. ุชุฃููุฏ ุงูุญุฐู
```typescript
โ๏ธ **ุชุฃููุฏ ุญุฐู ุงูุฅุฌุงุฒุฉ**

ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุฅุฌุงุฒุฉุ

๐ ุฑูู ุงูุฅุฌุงุฒุฉ: L-2024-001
๐ค ุงูุนุงูู: ูุญูุฏ ุฃุญูุฏ
๐ ุงูููุน: ุงุนุชูุงุฏูุฉ
๐ ูู: 03/11/2025
๐ ุฅูู: 08/11/2025
โฑ๏ธ ุงููุฏุฉ: 6 ุฃูุงู

โ๏ธ **ููุงุญุธุฉ:** ุณูุชู ุญุฐู ุงูุฅุฌุงุฒุฉ ุจุดูู ููุงุฆู (soft delete).

[โ ูุนูุ ุงุญุฐู ุงูุฅุฌุงุฒุฉ] [โ ูุงุ ุชุฑุงุฌุน]
```

##### 2. ุชูููุฐ ุงูุญุฐู (Soft Delete)
```typescript
await prisma.hR_EmployeeLeave.update({
  where: { id: leaveId },
  data: {
    isActive: false,      // ุฅุฎูุงุก ุงูุฅุฌุงุฒุฉ
    status: 'REJECTED',   // ุชุบููุฑ ุงูุญุงูุฉ ุฅูู ูุฑููุถุฉ
  },
})
```

#### ุงููููุฏ ุงูุฃูููุฉ:
- โ๏ธ ูุง ูููู ุญุฐู ุฅุฌุงุฒุฉ ุชู ุชุณุฌูู ุนูุฏุชูุง
- โ Soft delete (ูุง ูุชู ุญุฐู ุงูุจูุงูุงุช ูุนููุงู)
- โ ูุชู ุงูุงุญุชูุงุธ ุจุณุฌู ุงูุฅุฌุงุฒุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

### 5๏ธโฃ ุชุณุฌูู ุงููุนุงูุฌุงุช ุงูุฌุฏูุฏุฉ
**ุงูููู ุงููุนุฏู:** `src/bot/features/hr-management/index.ts`

#### ุงูุชุบููุฑุงุช:
```typescript
// ุฅุถุงูุฉ ุงููุงุฑุฏุงุช
import { leavesDeleteHandler } from './handlers/leaves-delete.handler.js'
import { leavesEditHandler } from './handlers/leaves-edit.handler.js'

// ุชุณุฌูู ุงููุนุงูุฌุงุช
composer.use(leavesEditHandler)   // โ ุชุนุฏูู ุงูุฅุฌุงุฒุงุช
composer.use(leavesDeleteHandler) // โ ุญุฐู ุงูุฅุฌุงุฒุงุช
```

---

## ๐ฏ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ

### ูุจู ุงูุชุญุฏูุซุงุช โ
1. ูููู ุชุณุฌูู ุฅุฌุงุฒุงุช ูุชุฏุงุฎูุฉ ูููุณ ุงูุนุงูู
2. ูุง ุชูุฌุฏ ูุณููุฉ ูุชุนุฏูู ุงูุฅุฌุงุฒุงุช ุงููุณุฌูุฉ
3. ูุง ุชูุฌุฏ ูุณููุฉ ูุญุฐู ุงูุฅุฌุงุฒุงุช ุงูุฎุงุทุฆุฉ
4. ุฑุณุงูุฉ ุฎุทุฃ ุบูุฑ ูุงุถุญุฉ ุนูุฏ ุนุฏู ูุฌูุฏ ุนุงูููู

### ุจุนุฏ ุงูุชุญุฏูุซุงุช โ
1. โ ููุน ุชุณุฌูู ุฅุฌุงุฒุงุช ูุชุฏุงุฎูุฉ ุชููุงุฆูุงู
2. โ ูุธุงู ุชุนุฏูู ุดุงูู (ุงูุชูุงุฑูุฎ - ุงูููุน - ุงูููุงุญุธุงุช)
3. โ ูุธุงู ุญุฐู ุขูู (soft delete) ูุน ุชุฃููุฏ
4. โ ุฑุณุงุฆู ุชูุถูุญูุฉ ูุงุถุญุฉ
5. โ ุญูุงูุฉ ูู ุงูุชุนุฏูู/ุงูุญุฐู ููุฅุฌุงุฒุงุช ุงูููุชููุฉ

---

## ๐ ููุฎุต ุงููููุงุช ุงููุนุฏูุฉ

| ุงูููู | ููุน ุงูุชุบููุฑ | ุงููุตู |
|-------|------------|-------|
| `leaves-add.handler.ts` | ุชุนุฏูู | ุชุตููุฉ ุงูุนุงูููู ุจุฅุฌุงุฒุงุช ูุนููุฉ |
| `leaves-list.handler.ts` | ุชุนุฏูู | ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุชุนุฏูู/ุญุฐู |
| `leaves-edit.handler.ts` | ุฌุฏูุฏ | ูุธุงู ุชุนุฏูู ุดุงูู |
| `leaves-delete.handler.ts` | ุฌุฏูุฏ | ูุธุงู ุญุฐู ุขูู |
| `index.ts` | ุชุนุฏูู | ุชุณุฌูู ุงููุนุงูุฌุงุช ุงูุฌุฏูุฏุฉ |

---

## ๐ ุงูุฃูุงู ูุงูุชุญูู

### ุงููููุฏ ุงููุทุจูุฉ:
1. โ **ูุง ุชุนุฏูู ุจุนุฏ ุงูุนูุฏุฉ:** ูููุน ุชุนุฏูู ุงูุฅุฌุงุฒุงุช ุงูุชู ุชู ุชุณุฌูู ุนูุฏุชูุง
2. โ **ูุง ุญุฐู ุจุนุฏ ุงูุนูุฏุฉ:** ูููุน ุญุฐู ุงูุฅุฌุงุฒุงุช ุงูููุชููุฉ
3. โ **ุชุญูู ูู ุงูุชูุงุฑูุฎ:** ุงูุชุญูู ูู ููุทููุฉ ุงูุชูุงุฑูุฎ ูุจู ุงูุญูุธ
4. โ **Soft Delete:** ูุง ูุชู ุญุฐู ุงูุจูุงูุงุช ูุนููุงู (ูููุฑุงุฌุนุฉ ุงููุณุชูุจููุฉ)
5. โ **ุชุฃููุฏ ุงูุญุฐู:** ุทูุจ ุชุฃููุฏ ูุจู ุงูุญุฐู

### ุฅุฏุงุฑุฉ ุงูุญุงูุฉ:
```typescript
// ุชุฎุฒูู ูุคูุช ููุญุงูุฉ
interface EditFormData {
  step: string
  leaveId: number
  employeeId?: number
  leaveType?: string
  startDate?: string
  endDate?: string
  notes?: string
}

const editData = new Map<number, EditFormData>()
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ ุงูููุตู ุจูุง:

#### 1. ุชุตููุฉ ุงูุนุงูููู
- [ ] ุงูุนุงูู ูู ุฅุฌุงุฒุฉ โ ูุง ูุธูุฑ ูู ูุงุฆูุฉ "ุฅุถุงูุฉ ุฅุฌุงุฒุฉ"
- [ ] ุงูุนุงูู ุจุฏูู ุฅุฌุงุฒุฉ โ ูุธูุฑ ูู ุงููุงุฆูุฉ
- [ ] ุนุงูู ุณุฌู ุนูุฏุชู โ ูุธูุฑ ูู ุงููุงุฆูุฉ

#### 2. ุชุนุฏูู ุงูุฅุฌุงุฒุฉ
- [ ] ุชุนุฏูู ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ุจูุฌุงุญ
- [ ] ุชุนุฏูู ุชุงุฑูุฎ ุงูููุงูุฉ ุจูุฌุงุญ
- [ ] ุฑูุถ ุชุงุฑูุฎ ุจุฏุงูุฉ > ุชุงุฑูุฎ ููุงูุฉ
- [ ] ุฑูุถ ุชุงุฑูุฎ ููุงูุฉ < ุชุงุฑูุฎ ุจุฏุงูุฉ
- [ ] ุชุนุฏูู ููุน ุงูุฅุฌุงุฒุฉ
- [ ] ุชุนุฏูู ุงูููุงุญุธุงุช
- [ ] ุฑูุถ ุชุนุฏูู ุฅุฌุงุฒุฉ ููุชููุฉ

#### 3. ุญุฐู ุงูุฅุฌุงุฒุฉ
- [ ] ุนุฑุถ ุชุฃููุฏ ุงูุญุฐู
- [ ] ุญุฐู ุจูุฌุงุญ (soft delete)
- [ ] ุงูุชุฃูุฏ ูู `isActive = false`
- [ ] ุงูุชุฃูุฏ ูู `status = REJECTED`
- [ ] ุฑูุถ ุญุฐู ุฅุฌุงุฒุฉ ููุชููุฉ

---

## ๐ ุงูุชูุงูู ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู

### ุงูุฃูุธูุฉ ุงููุชุฃุซุฑุฉ:
1. โ **ูุงุฆูุฉ ุงูุฅุฌุงุฒุงุช:** ุชุธูุฑ ููุท ุงูุฅุฌุงุฒุงุช ุงููุดุทุฉ (`isActive = true`)
2. โ **ุชุณุฌูู ุงูุนูุฏุฉ:** ูุง ุชุธูุฑ ุงูุฅุฌุงุฒุงุช ุงููุญุฐููุฉ
3. โ **ุงูุฅุดุนุงุฑุงุช:** ูุง ุชุฑุณู ุฅุดุนุงุฑุงุช ููุฅุฌุงุฒุงุช ุงููุญุฐููุฉ
4. โ **ุงูุชูุงุฑูุฑ:** ูููู ุชุตููุฉ ุงูุฅุฌุงุฒุงุช ุงููุญุฐููุฉ ุญุณุจ ุงูุญุงุฌุฉ

---

## ๐ ููุงุญุธุงุช ุฅุถุงููุฉ

### ุงููุฒุงูุง ุงููููุฉ:
- ๐ฏ **Code Reusability:** ุงุณุชุฎุฏุงู Calendar.create() ุงูููุฌูุฏ
- ๐งฉ **Modular Design:** ูุนุงูุฌุงุช ูููุตูุฉ ููู ูุธููุฉ
- ๐ **Type Safety:** ุงุณุชุฎุฏุงู TypeScript types ููุฃูุงู
- ๐ **State Management:** ุฅุฏุงุฑุฉ ุญุงูุฉ ุงูุฌูุณุงุช ุจููุงุกุฉ

### ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ ุงูููุชุฑุญุฉ:
1. ๐ **ุชุงุฑูุฎ ุงูุชุนุฏูู:** ุฅุถุงูุฉ ุณุฌู `lastModifiedAt` ู `modifiedBy`
2. ๐ **ุณุฌู ุงูุชุนุฏููุงุช:** Audit log ูุฌููุน ุงูุชุนุฏููุงุช
3. ๐ **ุฅุดุนุงุฑุงุช ุงูุชุนุฏูู:** ุฅุดุนุงุฑ ุงูุนุงูู ุนูุฏ ุชุนุฏูู ุฅุฌุงุฒุชู
4. ๐ **ุชูููู ูุชูุฏู:** ุฅุถุงูุฉ ุชูููู ุดูุฑู ููุงุฎุชูุงุฑ ูู ูุทุงู ุฃูุณุน

---

## โ ุงูุฎูุงุตุฉ

ุชู ุชูููุฐ ุฌููุน ุงูุทูุจุงุช ุจูุฌุงุญ:
1. โ ุชุตููุฉ ุงูุนุงูููู ุจุฅุฌุงุฒุงุช ูุนููุฉ ูู ูุงุฆูุฉ "ุฅุถุงูุฉ ุฅุฌุงุฒุฉ"
2. โ ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุชุนุฏูู ูุญุฐู ูุชูุงุตูู ุงูุฅุฌุงุฒุฉ
3. โ ูุธุงู ุชุนุฏูู ุดุงูู ูุฌููุน ุจูุงูุงุช ุงูุฅุฌุงุฒุฉ
4. โ ูุธุงู ุญุฐู ุขูู (soft delete) ูุน ุชุฃููุฏ
5. โ ุญูุงูุฉ ูุงููุฉ ูู ุงูุชุนุฏูู/ุงูุญุฐู ููุฅุฌุงุฒุงุช ุงูููุชููุฉ

**ุงููุธุงู ุฌุงูุฒ ููุงุฎุชุจุงุฑ ูุงูุงุณุชุฎุฏุงู! ๐**
