# ๐ ูุธุงู ุงูุฅุฌุงุฒุงุช - ุงูููุทู ุงูููุญุฏ

## ุชุงุฑูุฎ ุงูุชุญุฏูุซ: 7 ููููุจุฑ 2025

---

## โ ุงููุงุนุฏุฉ ุงูุฃุณุงุณูุฉ

**ุงูุฅุฌุงุฒุฉ ุงูุญุงููุฉ = ุฃู ุฅุฌุงุฒุฉ ูู ูุชู ุชุณุฌูู ุนูุฏุฉ ูุนููุฉ ููุง**

```typescript
actualReturnDate == null โ ุฅุฌุงุฒุฉ ุญุงููุฉ
actualReturnDate != null โ ุฅุฌุงุฒุฉ ููุชููุฉ (ูุณุฌูุฉ)
```

---

## ๐ ุญุงูุงุช ุงูุฅุฌุงุฒุงุช

### 1๏ธโฃ ุงูุฅุฌุงุฒุฉ ุงููุณุชูุจููุฉ ๐ต
- **ุงูุดุฑุท**: `startDate > ุงูููู AND actualReturnDate == null`
- **ุงููุนูู**: ุงูุฅุฌุงุฒุฉ ูู ุชุจุฏุฃ ุจุนุฏ
- **ุงูุนุฑุถ**: `ุงุณู ุงูุดูุฑุฉ (ุงููุธููุฉ) - ุชุจุฏุฃ ูู DD/MM/YYYY`

### 2๏ธโฃ ุงูุฅุฌุงุฒุฉ ุงูุฌุงุฑูุฉ ๐ข
- **ุงูุดุฑุท**: `startDate <= ุงูููู AND endDate >= ุงูููู AND actualReturnDate == null`
- **ุงููุนูู**: ุงูุนุงูู ูู ุฅุฌุงุฒุฉ ุงูุขู
- **ุงูุนุฑุถ**: `ุงุณู ุงูุดูุฑุฉ (ุงููุธููุฉ) - ุฌุงุฑูุฉ ุชูุชูู ูู DD/MM/YYYY`

### 3๏ธโฃ ุงูุฅุฌุงุฒุฉ ุงููุชุฃุฎุฑุฉ ๐ด
- **ุงูุดุฑุท**: `endDate < ุงูููู AND actualReturnDate == null`
- **ุงููุนูู**: ุงูุฅุฌุงุฒุฉ ุงูุชูุช ููู ููุณุฌู ุนูุฏุฉ
- **ุงูุนุฑุถ**: `ุงุณู ุงูุดูุฑุฉ (ุงููุธููุฉ) - ูุชุฃุฎุฑ X ููู`

---

## ๐งฎ ุญุณุงุจ ุงูุชุฃุฎูุฑ

**ุงููุงุนุฏุฉ**: ุงูุชุฃุฎูุฑ = (ุชุงุฑูุฎ ุงูุนูุฏุฉ ุงููุนูู) - (ุชุงุฑูุฎ ููุงูุฉ ุงูุฅุฌุงุฒุฉ + 1 ููู)

### ุฃูุซูุฉ:
- **ููุงูุฉ ุงูุฅุฌุงุฒุฉ**: 1 ููููุจุฑ
- **ุชุงุฑูุฎ ุงูุนูุฏุฉ ุงููุชููุน**: 2 ููููุจุฑ (ุตุจุงุญ ุงูููู ุงูุชุงูู)

| ุชุงุฑูุฎ ุงูุนูุฏุฉ ุงููุนูู | ุงูุชุฃุฎูุฑ |
|---------------------|---------|
| 1 ููููุจุฑ | -1 ููู (ูุจูุฑ) |
| 2 ููููุจุฑ | 0 ููู โ |
| 3 ููููุจุฑ | 1 ููู |
| 4 ููููุจุฑ | 2 ููู |

**ุงูุตูุบุฉ ุงูุจุฑูุฌูุฉ**:
```typescript
const expectedReturnDate = new Date(endDate)
expectedReturnDate.setDate(expectedReturnDate.getDate() + 1)

const delayDays = Math.floor(
  (actualReturnDate.getTime() - expectedReturnDate.getTime()) / (1000 * 60 * 60 * 24)
)

// delayDays > 0 โ ุชุฃุฎูุฑ
// delayDays == 0 โ ูู ุงูููุนุฏ
// delayDays < 0 โ ุนูุฏุฉ ูุจูุฑุฉ
```

---

## ๐ ุงููุธุงุฆู ูุงูุงุณุชุนูุงูุงุช

### 1. ูุงุฆูุฉ ุงูุฅุฌุงุฒุงุช ุงูุญุงููุฉ (`leaves:list`)

**ุงููุฏู**: ุนุฑุถ ุฌููุน ุงูุฅุฌุงุฒุงุช ุงูุชู ูู ุชูุณุฌู ุนูุฏุฉ ูุนููุฉ ููุง

**ุงูุงุณุชุนูุงู**:
```typescript
WHERE {
  isActive: true,
  status: ['PENDING', 'APPROVED'],
  allowanceAmount: null OR 0,
  actualReturnDate: null  // โ ุงููุนูุงุฑ ุงูุฃุณุงุณู
}
ORDER BY startDate ASC, endDate ASC
```

**ุงูุนุฑุถ**:
- ๐ต ูุณุชูุจููุฉ: `ุชุจุฏุฃ ูู ...`
- ๐ข ุฌุงุฑูุฉ: `ุฌุงุฑูุฉ ุชูุชูู ูู ...`
- ๐ด ูุชุฃุฎุฑุฉ: `ูุชุฃุฎุฑ X ููู`

---

### 2. ุชุณุฌูู ุงูุนูุฏุฉ (`leaves:return`)

**ุงููุฏู**: ุนุฑุถ ุงูุฅุฌุงุฒุงุช ุงูุชู **ุจุฏุฃุช ููุท** ููู ุชูุณุฌู ุนูุฏุฉ

**ุงูุงุณุชุนูุงู**:
```typescript
WHERE {
  isActive: true,
  status: ['PENDING', 'APPROVED'],
  allowanceAmount: null OR 0,
  actualReturnDate: null,
  startDate: <= ุงูููู  // โ ุจุฏุฃุช ูุนูุงู (ููุน ุงููุณุชูุจููุฉ)
}
ORDER BY employeeId ASC, createdAt DESC
```

**ุงูุณุจุจ**: ูุง ูููู ุชุณุฌูู ุนูุฏุฉ ูุฅุฌุงุฒุฉ ูู ุชุจุฏุฃ ุจุนุฏ!

---

### 3. ุงูุฅุดุนุงุฑุงุช

**ุชูุฑุณู ุนู**:

#### ุฃ) ุฅุฌุงุฒุงุช ูุชุฃุฎุฑุฉ ๐ด
```typescript
WHERE {
  status: 'APPROVED',
  endDate: < ุงูููู,
  actualReturnDate: null  // โ ูู ุชูุณุฌู ุนูุฏุฉ
}
```

#### ุจ) ุฅุฌุงุฒุงุช ุณุชุจุฏุฃ ุบุฏุงู ๐ต
```typescript
WHERE {
  nextLeaveStartDate: == ุบุฏุงู
}
```
(ุจูุงุกู ุนูู ุฌุฏูู ุงูุฃุฏูุงุฑ - `nextLeaveStartDate`)

---

### 4. ุฌุฏูู ุฃุฏูุงุฑ ุงูุฅุฌุงุฒุงุช (`leaves:schedule`)

**ุงููุฏู**: ุนุฑุถ ููุงุนูุฏ ุงูุฅุฌุงุฒุงุช ุงููุงุฏูุฉ ุจูุงุกู ุนูู ุฏูุฑุฉ ุงูุนูู

**ููุงุญุธุฉ ูุงูุฉ**: 
- โ ุฌุฏูู ุงูุฃุฏูุงุฑ = ุชูุจุค ุจุงูููุงุนูุฏ ุงููุงุฏูุฉ
- โ **ููุณ ูู ุนูุงูุฉ** ุจุชุณุฌูู ุงูุฅุฌุงุฒุงุช ุงููุนููุฉ ุฃู ุงูุนูุฏุฉ ุฃู ุงูุชุฃุฎูุฑ

**ุงููุตุฏุฑ**: `Employee.nextLeaveStartDate` (ูุชู ุญุณุงุจูุง ูู ุฏูุฑุฉ ุงูุนูู ูุงูุฅุฌุงุฒุงุช)

---

## ๐ฏ ููุฎุต ุงููุฑููุงุช

| ุงููุธููุฉ | ุงูุดุฑุท ุงูุฃุณุงุณู | ูู ุชุธูุฑ ุงููุณุชูุจููุฉุ | ูู ุชุธูุฑ ุงูุฌุงุฑูุฉุ | ูู ุชุธูุฑ ุงููุชุฃุฎุฑุฉุ |
|---------|---------------|-------------------|------------------|------------------|
| ูุงุฆูุฉ ุงูุฅุฌุงุฒุงุช | `actualReturnDate == null` | โ ูุนู | โ ูุนู | โ ูุนู |
| ุชุณุฌูู ุงูุนูุฏุฉ | `startDate <= ุงูููู AND actualReturnDate == null` | โ ูุง | โ ูุนู | โ ูุนู |
| ุงูุฅุดุนุงุฑุงุช (ูุชุฃุฎุฑ) | `endDate < ุงูููู AND actualReturnDate == null` | โ ูุง | โ ูุง | โ ูุนู |
| ุงูุฅุดุนุงุฑุงุช (ุณุชุจุฏุฃ) | `nextLeaveStartDate == ุบุฏุงู` | โ ูุนู | โ ูุง | โ ูุง |
| ุฌุฏูู ุงูุฃุฏูุงุฑ | `nextLeaveStartDate != null` | โ ูุนู | โ ูุง | โ ูุง |

---

## ๐ซ ุงูุญุงูุงุช ุงููุณุชุซูุงุฉ

### ูุง ุชุธูุฑ ูู ุฃู ูุงุฆูุฉ:
- โ `actualReturnDate != null` (ุชู ุชุณุฌูู ุนูุฏุฉ)
- โ `status: 'REJECTED'` (ูุฑููุถุฉ)
- โ `isActive: false` (ุบูุฑ ูุดุทุฉ)
- โ `allowanceAmount > 0` (ุฅุฌุงุฒุฉ ุจุฏู)

---

## ๐ ุงููููุงุช ุงููุญุฏุซุฉ

1. โ `src/modules/services/leave-notifications.ts`
   - ุฅุถุงูุฉ ุดุฑุท `actualReturnDate: null` ูู `checkOverdueLeaves()`
   
2. โ `src/modules/services/leave-schedule.service.ts`
   - ุฅุถุงูุฉ ุดุฑุท `actualReturnDate: null` ูู `getOverdueLeaves()`
   
3. โ `src/bot/features/hr-management/handlers/leaves-return.handler.ts`
   - ุฅุถุงูุฉ ุดุฑุท `startDate <= today` ูููุน ุงูุฅุฌุงุฒุงุช ุงููุณุชูุจููุฉ
   
4. โ `src/bot/features/hr-management/handlers/leaves-list.handler.ts`
   - ุฅุนุงุฏุฉ ููููุฉ ูุงููุฉ
   - ุฅุฒุงูุฉ ุดุฑูุท `startDate/endDate`
   - ุงูุงุนุชูุงุฏ ููุท ุนูู `actualReturnDate`
   - ุฅุถุงูุฉ ุฃููููุงุช ุงูุญุงูุฉ (๐ต๐ข๐ด)

---

## โ ูุชุงุฆุฌ ุงูุชุญููู

ุจุนุฏ ุงูุชุทุจูู:
- **ูุงุฆูุฉ ุงูุฅุฌุงุฒุงุช**: 7-9 ุฅุฌุงุฒุงุช (ุจุฏูุงู ูู 0)
- **ุชุณุฌูู ุงูุนูุฏุฉ**: 7 ุฅุฌุงุฒุงุช (ุจุฏูุงู ูู 1 ูุณุชูุจููุฉ)
- **ุงูุฅุดุนุงุฑุงุช**: 6-7 ุฅุดุนุงุฑุงุช (ุจุฏูุงู ูู 52)

**ุงููุธุงู ุงูุขู ููุทูู ููุชูุงูู 100%** โ
