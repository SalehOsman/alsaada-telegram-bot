# 13. نظام التسويات والمعاملات (Settlements & Transactions System)

---

## مقدمة

نظام التسويات والمعاملات يتيح إدارة جميع أنواع السلف، المسحوبات، التسويات الجماعية والفردية، مع سجل تدقيق كامل ومرونة في ربطها بأنظمة الرواتب والإجازات.

---

## الأهداف الرئيسية للنظام
- إدارة السلف والمعاملات المالية للموظفين.
- دعم التسويات الجماعية والفردية.
- سجل تدقيق كامل لكل معاملة وتغيير.
- تصدير تقارير المعاملات والتسويات.

---

## الهيكل العام للنظام

- **Handlers رئيسية:**
  - transactions-new.handler.ts
  - transactions-view.handler.ts
  - transactions-reports.handler.ts
  - transactions-items.handler.ts
  - settlements.handler.ts
- **الجداول المرتبطة:**
  - HR_Transaction
  - HR_TransactionItem
  - HR_TransactionSettlement
  - HR_TransactionChangeLog
- **Enums:**
  - TransactionType
  - SettlementType
  - TransactionChangeType

---

## 1. إدارة السلف والمعاملات (Advances & Transactions)

### الوظيفة:
- إضافة، تعديل، حذف معاملات مالية (سلفة، مسحوبات، إلخ).
- ربط المعاملة بالموظف، النوع، التاريخ، القيمة.

### السيناريو:
1. اختيار الموظف.
2. تحديد نوع المعاملة (سلفة، مسحوبات، إلخ).
3. إدخال التفاصيل (القيمة، التاريخ، الملاحظات).
4. حفظ المعاملة.

### مثال واجهة برمجية:
```
[إضافة معاملة]
- الموظف: أحمد علي
- النوع: سلفة
- القيمة: 1000
- التاريخ: 2025-11-05
[حفظ]
```

---

## 2. التسويات الجماعية والفردية (Settlements)

### الوظيفة:
- تسوية معاملة واحدة أو عدة معاملات دفعة واحدة.
- تحديد نوع التسوية (كاملة/جزئية/مخصصة).
- ربط التسوية مع الرواتب أو الإجازات.

### السيناريو:
1. اختيار المعاملات المطلوب تسويتها.
2. تحديد نوع التسوية.
3. النظام يحسب القيمة المتبقية.
4. حفظ التسوية وتحديث السجلات.

### مثال واجهة برمجية:
```
[تسوية جماعية]
- الموظفون: أحمد علي، محمد حسن
- المعاملات: سلفة 1000، مسحوبات 500
- نوع التسوية: كاملة
- القيمة المسددة: 1500
[حفظ]
```

---

## 3. سجل التغييرات (Change Log)

### الوظيفة:
- تتبع جميع التعديلات على المعاملات والتسويات.
- تسجيل من قام بالتعديل، متى، وما هو التغيير.

### السيناريو:
1. عرض سجل التغييرات لكل معاملة.
2. تصدير السجل للمراجعة.

### مثال واجهة برمجية:
```
[سجل التغييرات - سلفة أحمد علي]
| التاريخ      | العملية         | القديم | الجديد | من قام بالتعديل |
|--------------|----------------|--------|--------|----------------|
| 2025-11-10   | تعديل القيمة    | 1000   | 1200   | مدير الحسابات  |
```

---

## 4. تقارير المعاملات والتسويات (Reports)

### الوظيفة:
- تصدير تقارير مفصلة عن جميع المعاملات والتسويات.
- فلترة حسب الموظف، النوع، الفترة.

### السيناريو:
1. تحديد الموظف أو الفترة أو النوع.
2. تصدير التقرير إلى Excel أو PDF.

### مثال واجهة برمجية:
```
[تقرير المعاملات]
- الموظف: أحمد علي
- الفترة: 2025-01-01 إلى 2025-11-01
- مجموع السلف: 5000
- مجموع المسحوبات: 2000
- التسويات: 3
[تصدير PDF]
```

---

## 5. الجداول المرتبطة (Database Tables)

### HR_Transaction
- جميع المعاملات المالية.
- الحقول: id, employeeId, type, value, date, status, notes

### HR_TransactionItem
- أصناف المسحوبات.
- الحقول: id, transactionId, itemName, value

### HR_TransactionSettlement
- التسويات المالية.
- الحقول: id, transactionId, value, type, date, settledBy

### HR_TransactionChangeLog
- سجل التغييرات على المعاملات.
- الحقول: id, transactionId, action, oldValue, newValue, changedBy, changedAt

---

## 6. أفضل الممارسات
- مراجعة جميع التسويات بشكل دوري.
- تفعيل سجل التغييرات لكل معاملة.
- تصدير تقارير المعاملات شهرياً.

---

## 7. ملخص

نظام التسويات والمعاملات يوفر أتمتة كاملة لإدارة السلف، المسحوبات، التسويات، مع سجل تدقيق مفصل ومرونة في ربطها بأنظمة الرواتب والإجازات.

---

**آخر تحديث:** 7 نوفمبر 2025
