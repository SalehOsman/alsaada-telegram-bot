# 🔄 نظام دورة العمل والإجازات - الملخص المرئي

## 📊 نظرة عامة سريعة

```mermaid
graph TB
    A[🔄 دورة العمل والإجازات] --> B[🏢 إدارة الوظائف]
    A --> C[👤 إدارة الموظفين]
    A --> D[📊 التقارير]
    
    B --> B1[قائمة الوظائف]
    B --> B2[تحديد قيم افتراضية]
    B --> B3[عرض الموظفين]
    
    C --> C1[عرض بفلاتر]
    C --> C2[تعديل مخصص]
    C --> C3[استعادة افتراضي]
    C --> C4[بحث بالاسم]
    
    D --> D1[تصدير Excel]
    D --> D2[سجل التدقيق]
```

---

## 🏗️ البنية الهرمية

```
📋 إدارة دورة العمل والإجازات
│
├── 🏢 إدارة دورات الوظائف
│   ├── قائمة الوظائف (مع عدد الموظفين)
│   ├── عرض تفاصيل الوظيفة
│   ├── تعديل القيم الافتراضية
│   └── عرض موظفي الوظيفة
│
├── 👤 إدارة دورات الموظفين
│   ├── قائمة الموظفين
│   │   ├── 📋 جميع الموظفين
│   │   ├── ✅ افتراضي فقط
│   │   ├── 🔧 مخصص فقط
│   │   └── ❌ غير محدد
│   ├── عرض تفاصيل الموظف
│   ├── تعديل دورة الموظف
│   ├── استعادة القيم الافتراضية
│   └── 🔍 بحث بالاسم
│
└── 📊 التقارير
    ├── تصدير Excel شامل
    └── سجل التدقيق (Audit Log)
```

---

## 🗄️ نموذج البيانات

```mermaid
erDiagram
    Position ||--o{ Employee : has
    Position {
        int id PK
        string titleAr
        int defaultWorkDaysPerCycle
        int defaultLeaveDaysPerCycle
    }
    
    Employee {
        int id PK
        string fullName
        int positionId FK
        int workDaysPerCycle
        int leaveDaysPerCycle
        bool hasCustomCycle
    }
    
    Employee ||--o{ HR_CycleChangeLog : generates
    Position ||--o{ HR_CycleChangeLog : generates
    
    HR_CycleChangeLog {
        int id PK
        string entityType
        int entityId
        int oldWorkDays
        int oldLeaveDays
        int newWorkDays
        int newLeaveDays
        bigint changedBy
        datetime changedAt
        string reason
    }
```

---

## 🔄 تدفق العمل الرئيسي

### **1️⃣ إعداد وظيفة جديدة**

```mermaid
sequenceDiagram
    participant U as المستخدم
    participant S as النظام
    participant DB as قاعدة البيانات
    
    U->>S: اختيار الوظيفة
    S->>DB: جلب بيانات الوظيفة
    DB-->>S: بيانات الوظيفة
    S-->>U: عرض التفاصيل
    U->>S: تعديل القيم (20/10)
    S->>DB: تحديث defaultWorkDaysPerCycle & defaultLeaveDaysPerCycle
    S->>DB: إنشاء سجل في HR_CycleChangeLog
    DB-->>S: تم الحفظ
    S-->>U: ✅ تم التحديث
```

---

### **2️⃣ تخصيص دورة لموظف**

```mermaid
sequenceDiagram
    participant U as المستخدم
    participant S as النظام
    participant DB as قاعدة البيانات
    
    U->>S: اختيار الموظف
    S->>DB: جلب بيانات الموظف + الوظيفة
    DB-->>S: بيانات كاملة
    S-->>U: عرض التفاصيل
    U->>S: تعديل القيم (25/12)
    S->>DB: تحديث workDaysPerCycle & leaveDaysPerCycle
    S->>DB: تعيين hasCustomCycle = true
    S->>DB: إنشاء سجل في HR_CycleChangeLog
    DB-->>S: تم الحفظ
    S-->>U: ✅ تم التحديث<br/>🔧 الموظف أصبح مخصص
```

---

### **3️⃣ استعادة القيم الافتراضية**

```mermaid
sequenceDiagram
    participant U as المستخدم
    participant S as النظام
    participant DB as قاعدة البيانات
    
    U->>S: استعادة الافتراضي
    S->>DB: جلب قيم الوظيفة الافتراضية
    
    alt الوظيفة لديها قيم افتراضية
        DB-->>S: القيم موجودة (20/10)
        S->>DB: نسخ القيم للموظف
        S->>DB: تعيين hasCustomCycle = false
        S->>DB: إنشاء سجل تدقيق
        DB-->>S: تم الحفظ
        S-->>U: ✅ تمت الاستعادة<br/>أيام العمل: 20<br/>أيام الإجازة: 10
    else الوظيفة بدون قيم افتراضية
        DB-->>S: القيم null
        S-->>U: ⚠️ الوظيفة لا تحتوي على قيم افتراضية
    end
```

---

## 📊 أنواع العرض

### **الفلاتر المتاحة**

```
┌─────────────────────────────────────────┐
│  📋 جميع الموظفين                      │
│  ────────────────────────────────────  │
│  ✅ صالح رجب - طباخ (30/10)           │
│  🔧 أحمد محمد - فني (25/12)           │
│  ❌ علي حسن - مساعد (؟/؟)             │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  ✅ افتراضي فقط                        │
│  ────────────────────────────────────  │
│  صالح رجب - طباخ (30/10)              │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  🔧 مخصص فقط                           │
│  ────────────────────────────────────  │
│  أحمد محمد - فني (25/12) 🔧           │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  ❌ غير محدد                           │
│  ────────────────────────────────────  │
│  علي حسن - مساعد (؟/؟)                │
└─────────────────────────────────────────┘
```

---

## 📈 تقرير Excel

### **هيكل التقرير**

```
┌───┬─────────────┬──────────┬────────┬──────────┬──────────┬─────┬─────────┬─────────┐
│ # │    الاسم    │  الوظيفة │ القسم  │ أيام العمل│أيام الإجازة│مخصص│ افتراضي│ افتراضي│
│   │             │          │        │          │          │     │  العمل  │ الإجازة │
├───┼─────────────┼──────────┼────────┼──────────┼──────────┼─────┼─────────┼─────────┤
│ 1 │ صالح رجب    │ فني صيانة│ الصيانة│    25    │    12    │ نعم │   20    │   10    │
│ 2 │ أحمد محمد   │ طباخ      │ الإعاشة│    30    │    10    │ لا  │   30    │   10    │
│ 3 │ علي حسن     │ مساعد     │ الصيانة│ غير محدد │ غير محدد │ لا  │   20    │   10    │
└───┴─────────────┴──────────┴────────┴──────────┴──────────┴─────┴─────────┴─────────┘
```

---

## 🔐 الصلاحيات والأمان

```mermaid
graph TD
    A[طلب الوصول] --> B{SUPER_ADMIN?}
    B -->|نعم| C[✅ السماح بالوصول]
    B -->|لا| D[❌ رفض الوصول]
    
    C --> E[checkHRAccess Middleware]
    E --> F[الوصول للنظام]
    
    F --> G[إدارة الوظائف]
    F --> H[إدارة الموظفين]
    F --> I[التقارير]
    
    G --> J[حفظ في Audit Log]
    H --> J
    I --> J
```

---

## 📝 سجل التدقيق (Audit Log)

### **ما يتم تسجيله:**

```
📋 كل تغيير يُسجل مع:
├── نوع الكيان (Position أو Employee)
├── ID الكيان
├── القيمة القديمة (Work & Leave)
├── القيمة الجديدة (Work & Leave)
├── من أجرى التغيير (Telegram User ID)
├── تاريخ ووقت التغيير
└── السبب (اختياري)
```

### **مثال على السجل:**

```json
{
  "id": 1,
  "entityType": "Employee",
  "entityId": 15,
  "oldWorkDays": 20,
  "oldLeaveDays": 10,
  "newWorkDays": 25,
  "newLeaveDays": 12,
  "changedBy": "7594239391",
  "changedAt": "2025-11-04T21:17:35.000Z",
  "reason": null
}
```

---

## 🎯 حالات الاستخدام الشائعة

### **السيناريو 1: موظف جديد**

```
1. إضافة موظف جديد
   └── النظام يتحقق من وظيفته
       ├── [✅ لديها قيم افتراضية]
       │   └── يرث القيم تلقائياً
       │       └── hasCustomCycle = false
       └── [❌ ليس لديها قيم]
           └── يبقى null
               └── hasCustomCycle = false
```

---

### **السيناريو 2: تعديل وظيفة**

```
1. تعديل قيم الوظيفة (من 20/10 إلى 21/11)
   ├── الموظفون الحاليون
   │   ├── [🔧 مخصص] → لا يتأثر (محمي)
   │   └── [✅ افتراضي] → لا يتأثر (يحتفظ بقيمه)
   └── الموظفون المستقبليون
       └── يرثون القيم الجديدة (21/11)
```

---

### **السيناريو 3: استعادة افتراضي**

```
1. موظف مخصص (25/12) 🔧
   └── طلب استعادة الافتراضي
       └── التحقق من قيم الوظيفة
           ├── [✅ موجودة] (20/10)
           │   ├── نسخ القيم للموظف
           │   ├── hasCustomCycle = false
           │   └── ✅ تمت الاستعادة
           └── [❌ غير موجودة] (null)
               └── ⚠️ يجب تحديد قيم الوظيفة أولاً
```

---

## 🔧 التكامل مع الأنظمة الأخرى

### **الأنظمة القابلة للربط:**

```mermaid
graph LR
    A[دورة العمل والإجازات] --> B[نظام الإجازات]
    A --> C[نظام الرواتب]
    A --> D[نظام الحضور]
    A --> E[نظام التقارير]
    
    B --> B1[حساب استحقاق الإجازة]
    C --> C1[حساب الأجر اليومي]
    D --> D1[تحديد أيام العمل المطلوبة]
    E --> E1[تقارير الدورات والإحصائيات]
```

---

## 📊 الإحصائيات

```
📁 الملفات:           6 ملفات
🎯 الوظائف الرئيسية:  3 وظائف
💼 الوظائف الفرعية:   15+ وظيفة
🗄️ جداول قاعدة البيانات: 3 جداول (موجودة + معدلة)
📝 سطور الكود:        ~800 سطر
⏱️ وقت التطوير:      يوم واحد
```

---

## 🎓 الخلاصة المرئية

```
┌────────────────────────────────────────────────────────┐
│  🔄 نظام إدارة دورة العمل والإجازات                   │
│  ──────────────────────────────────────────────────── │
│                                                        │
│  ✅ إدارة على مستوى الوظيفة (قيم افتراضية)          │
│  ✅ إدارة على مستوى الموظف (قيم مخصصة)              │
│  ✅ حماية من التعديلات الخاطئة (hasCustomCycle)      │
│  ✅ سجل تدقيق كامل لكل التغييرات                     │
│  ✅ فلاتر متقدمة للعرض والبحث                        │
│  ✅ تقارير Excel شاملة وجاهزة                        │
│  ✅ واجهة سهلة وبديهية                               │
│                                                        │
│  🔒 الصلاحية: SUPER_ADMIN فقط                        │
│  📅 آخر تحديث: 4 نوفمبر 2025                         │
│  🏷️ الإصدار: v1.1.0                                  │
└────────────────────────────────────────────────────────┘
```

---

**للتوثيق الكامل:** راجع [`11_WORK_LEAVE_CYCLE_SYSTEM.md`](./11_WORK_LEAVE_CYCLE_SYSTEM.md)

**للدليل السريع:** راجع [`WORK_LEAVE_CYCLE_QUICK_GUIDE.md`](./WORK_LEAVE_CYCLE_QUICK_GUIDE.md)
