# **๐ฆ ุฎุทุฉ ุฅุนุงุฏุฉ ููููุฉ ูุธุงู ุงููุฎุงุฒู (Inventory System Refactoring)**

ุงูุชุงุฑูุฎ: 16 ููููุจุฑ 2025  
ุงูููุนุฏ: (ุงุณูู/ุงุณู ูุฑููู)  
ุงูุฅุตุฏุงุฑ: 1.0

## **1\. ููุฎุต ุชูููุฐู (Executive Summary)**

ูุนุงูู ุงูุชุตููู ุงูุญุงูู ููุงุนุฏุฉ ุจูุงูุงุช ุงููุฎุงุฒู ูู prisma.schema ูู ูุดููุชูู ุฑุฆูุณูุชูู:

1. **ุชูุฑุงุฑ ุงููููู (Repetition):** ูุชู ุฅูุดุงุก ูุฌููุนุฉ ุฌุฏุงูู ูุงููุฉ (Item, Purchase, Issuance...) ููู ููุน ูุฎุฒู (ูุฑุฉ ููุทุน ุงูุบูุงุฑ INV\_SparePartุ ููุฑุฉ ููุฒููุช INV\_OilsGreasesItemุ ููุฎุทุท ูุชูุฑุงุฑูุง ููุณููุงุฑ ูุงูุฃุฏูุงุช).  
2. **ุฏูุฌ ุชุนุฑูู ุงูุตูู ุจุฑุตูุฏู (Item-Stock Coupling):** ุงูุฌุฏุงูู ุงูุญุงููุฉ (INV\_SparePart) ุชุฏูุฌ ุชุนุฑูู ุงูุตูู (ุงุณููุ ุจุงุฑููุฏ) ูุน ุฑุตูุฏู (quantity, locationId)ุ ููุง ูููุน ุงูุตูู ุงููุงุญุฏ ูู ุงูุชูุงุฌุฏ ูู ุฃูุซุฑ ูู ูููุน ุชุฎุฒูู.

ูุฐู ุงูุฎุทุฉ ุชุทุฑุญ ุญูุงู ุฌุฐุฑูุงู **ุจุชูุญูุฏ (Unify)** ุฌููุน ุฃููุงุน ุงููุฎุงุฒู ุชุญุช ูููู ูุงุญุฏ ูุดุชุฑูุ ุจูุงุกู ุนูู ุงููุจุงุฏุฆ ุงูููุชุงุฒุฉ ุงููุฐููุฑุฉ ูู ููู ุงูุชูุซูู ุงูุฃููู ูููุดุฑูุน (Documentation\_Pro/Inventory Management/02\_DATABASE\_SCHEMA.md).

**ุงููุฏู:** ุงูุงูุชูุงู ูู 4 ุฃูุธูุฉ ูุฎุงุฒู ููุฑุฑุฉ ุฅูู **ูุธุงู ูุงุญุฏ ููุญุฏ** ูููุฑ ููุงุกุฉ ุฃุนูู ูู ุงูุจุญุซุ ุณูููุฉ ูุทููุฉ ูู ุงูุตูุงูุฉุ ููุงุจููุฉ ูุงุฆูุฉ ููุชูุณุน.

## **2\. ุงููููู ุงููุฏู (Target Architecture)**

ุจุฏูุงู ูู ุชูุฑุงุฑ ุงูุฌุฏุงููุ ุณูุนุชูุฏ ุนูู 4 ููุงูุงุช ุฑุฆูุณูุฉ:

1. **INV\_Category (ุงููุฆุงุช):** ุฌุฏูู ูุงุญุฏ ูุชุนุฑูู *ุฃููุงุน* ุงููุฎุงุฒู (ูุทุน ุบูุงุฑุ ุฒููุชุ ุณููุงุฑุ ุฃุฏูุงุช).  
2. **INV\_Item (ูุชุงููุฌ ุงูุฃุตูุงู):** ุฌุฏูู ูุงุญุฏ ูุชุนุฑูู *ูู* ุงูุฃุตูุงู (ููุชุฑ ุฒูุชุ ุฒูุช ููุฏุฑููููุ ูุชุฑ ุณููุงุฑ...).  
3. **INV\_Stock (ุงูุฃุฑุตุฏุฉ):** ุฌุฏูู ุฌุฏูุฏ ูุฑุจุท ุงูุตูู ุจุงููููุน ูุชุฎุฒูู ุงูุฑุตูุฏ (itemId \+ locationId \= quantity). ูุฐุง ูุญู ูุดููุฉ ุชุนุฏุฏ ุงูููุงูุน.  
4. **INV\_Transaction (ุงูุญุฑูุงุช):** ุฌุฏูู ูุงุญุฏ ูุณุฌู *ูู* ุงูุญุฑูุงุช (ุฅุถุงูุฉุ ุตุฑูุ ูููุ ุฅุฑุฌุงุนุ ุชุณููุฉ) ูุฌููุน ุงูุฃุตูุงู.

## **3\. ุฎุทุฉ ุงูุชูููุฐ (Implementation Plan)**

### **ุงููุฑุญูุฉ ุงูุฃููู: ุชุนุฏูู Prisma Schema**

**ุชุญุฐูุฑ: ูู ุจุฃุฎุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ ูู ููู prisma/schema.prisma ููุงุนุฏุฉ ุงูุจูุงูุงุช ูุจู ุงูุจุฏุก.**

1. **ุชูุญูุฏ ุงููุฆุงุช (Categories):**  
   * ุงุญุฐู INV\_OilsGreasesCategory.  
   * ุฃุนุฏ ุชุณููุฉ INV\_EquipmentCategory ุฅูู INV\_Category.  
   * ุฃุถู ุญููุงู ุฌุฏูุฏุงู ูู INV\_Category ุจุงุณู inventoryType (ููุน ุงููุฎุฒู) ููููู ุงูููุชุฑ ุงูุฑุฆูุณู (ูุซู: SPARE\_PART, OILS\_GREASE, FUEL, TOOLS).  
2. **ุชูุญูุฏ ุงูุฃุตูุงู (Items):**  
   * ุงุญุฐู INV\_OilsGreasesItem.  
   * ุฃุนุฏ ุชุณููุฉ INV\_SparePart ุฅูู INV\_Item.  
   * **(ูุงู ุฌุฏุงู)** ุงุญุฐู ุฌููุน ุงูุญููู ุงููุชุนููุฉ ุจุงูุฑุตูุฏ ูุงููููุน ูู INV\_Item. ุงูุญููู ุงูุชู ูุฌุจ ุญุฐููุง:  
     * locationId, quantity, quantityNew, quantityUsed, quantityRefurbished, quantityImport, unitPrice, totalValue, condition, status, isDamaged ูุฌููุน ุญููู damage...  
   * ุนุฏูู ุนูุงูุฉ categoryId ูู INV\_Item ูุชุฑุจุท ุจุงูุฌุฏูู ุงูุฌุฏูุฏ INV\_Category.  
3. **ุฅูุดุงุก ุฌุฏูู ุงูุฃุฑุตุฏุฉ (Stock):**  
   * ุฃูุดุฆ ุฌุฏูู INV\_Stock ุงูุฌุฏูุฏ (ุงูุธุฑ ุงูููู 01\_Inventory\_Schema\_TARGET.prisma.md ููุชูุงุตูู).  
   * ูุฐุง ุงูุฌุฏูู ุณูุญุชูู ุนูู ุงูุญููู ุงูุชู ุญุฐูุชูุง ูู INV\_Item (ูุซู locationId, quantity, quantityNew...ุฅูุฎ) ุจุงูุฅุถุงูุฉ ุฅูู ุญูู averageCost ูุญุณุงุจ ูุชูุณุท ุงูุชูููุฉ.  
4. **ุชูุญูุฏ ุงูุญุฑูุงุช (Transactions):**  
   * ุงุญุฐู ุงูุฌุฏุงูู ุงูุฎูุณุฉ ุงูููุฑุฑุฉ: INV\_OilsGreasesPurchase, INV\_OilsGreasesIssuance, INV\_OilsGreasesTransfer, INV\_OilsGreasesReturn, INV\_OilsGreasesAdjustment.  
   * ุฃุนุฏ ุชุณููุฉ INV\_SparePartTransaction ุฅูู INV\_Transaction.  
   * ุนุฏูู ุญูู sparePartId ููุตุจุญ itemId ููุฑุจุท ุจู INV\_Item.  
   * ุชุฃูุฏ ูู ุฃู transactionType (ููุน ุงูุญุฑูุฉ) ูุฏุนู ูู ุงูุญุงูุงุช (IN\_PURCHASE, OUT\_USAGE, TRANSFER, RETURN, ADJUSTMENT, DAMAGE\_WRITE\_OFF).  
   * **(ูุงู)** ูุฌุจ ุฃู ุชุฑุจุท ูุฐู ุงูุญุฑูุฉ ุงูุขู ุจู stockId (ูุนุฑู ุงูุฑุตูุฏ) ุจุฏูุงู ูู itemId ูุจุงุดุฑุฉุ ุฃู ุฃู ุชุญุชูู ุนูู itemId ู locationId.  
5. **ุชุทุจูู ุงูุชุนุฏููุงุช:**  
   * ูู ุจุชุดุบูู: npx prisma format ูุชูุณูู ุงูููู.  
   * ูู ุจุชุดุบูู: npx prisma migrate dev \--name unify-inventory-module ูุฅูุดุงุก ููู ุงูุชุฑุญูู (migration) ุงูุฌุฏูุฏ. **ูุฐุง ุงูููู ุณูููู ูุงุฑุบุงู ูู ุงูุจุฏุงูุฉ.**

### **ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุชุฑุญูู ุงูุจูุงูุงุช (Data Migration)**

ูุฐู ูู ุงูุฎุทูุฉ ุงูุฃูุซุฑ ุญุณุงุณูุฉ. ูุฌุจ ุนููู ูุชุญ ููู ุงูู migration (.sql) ุงูุฐู ุชู ุฅูุดุงุคู ูู ุงูุฎุทูุฉ ุงูุณุงุจูุฉุ ููุชุงุจุฉ ุณูุฑูุจุช SQL ูููู ุงูุจูุงูุงุช **ูุจู** ุชุทุจูู ุงูู schema ุงูุฌุฏูุฏ.

**ูุฌุจ ุชูููุฐ ูุฐุง ุนุจุฑ ุณูุฑูุจุช ุจุฑูุฌู (TypeScript) ูุถูุงู ุงูุฏูุฉ.** (ุงูุธุฑ ุงูููู 02\_Inventory\_Migration\_Script.ts.md ููููุทู).

1. **ุฅูุดุงุก ุงูุณูุฑูุจุช:** ุฃูุดุฆ ูููุงู (ูุซู scripts/migrate-inventory.ts).  
2. **ุชูููุฐ ุงูููุทู:**  
   * ุฌูุจ ูู INV\_EquipmentCategory ูุฅุถุงูุชูุง ูู INV\_Category (ูุน inventoryType: 'SPARE\_PART').  
   * ุฌูุจ ูู INV\_OilsGreasesCategory ูุฅุถุงูุชูุง ูู INV\_Category (ูุน inventoryType: 'OILS\_GREASE').  
   * **ุงูุชุฑุญูู ุงูุญูููู (ุฏุงุฎู prisma.$transaction):**  
     * ููู INV\_SparePart ูุฏูู:  
       1. CREATE ุณุฌู INV\_Item ุฌุฏูุฏ ุจุงูุจูุงูุงุช ุงูุชุนุฑูููุฉ (name, code, barcode).  
       2. CREATE ุณุฌู INV\_Stock ุฌุฏูุฏ ุจุงูุจูุงูุงุช ุงููุฎุฒููุฉ (quantity, locationId, unitPrice as averageCost) ูุฑุจุทู ุจู INV\_Item ุงูุฌุฏูุฏ.  
     * ููู INV\_OilsGreasesItem ูุฏูู: ูุฑุฑ ููุณ ุงูุฎุทูุฉ (1 ู 2).  
     * ููู INV\_SparePartTransaction ูุฏูู: CREATE ุณุฌู INV\_Transaction ุฌุฏูุฏ ุจุนุฏ ุฑุจุทู ุจุงูู itemId ุงูุตุญูุญ.  
     * ููู INV\_OilsGreasesPurchase ูุฏูู: CREATE ุณุฌู INV\_Transaction (ุจููุน IN\_PURCHASE) ูุฑุจุทู ุจู itemId.  
     * ... ูุฑุฑ ูุจุงูู ุญุฑูุงุช ุงูุฒููุช (Issuance, Transfer...).  
3. **ุชูููุฐ ุงูุชุฑุญูู:** ูู ุจุชุดุบูู ุงูุณูุฑูุจุช.  
4. **ุชุทุจูู ุงูู Schema:** ุงูุขู ูู ุจุชุดุบูู npx prisma migrate dev ูุฑุฉ ุฃุฎุฑู ูุชุทุจูู ุงูุชุบููุฑุงุช ุงููุนููุฉ ุนูู ุงูุฌุฏุงูู (ุจุนุฏ ุฃู ุฃุตุจุญุช ุงูุฌุฏุงูู ุงููุฏููุฉ ูุงุฑุบุฉ ูุงูุจูุงูุงุช ูู ุงูุฌุฏุงูู ุงูุฌุฏูุฏุฉ).

### **ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุฅุนุงุฏุฉ ููููุฉ ุงูููุฏ (Code Refactoring)**

1. **ุญุฐู ุงูุฎุฏูุงุช ุงูููุฑุฑุฉ:**  
   * ุงุญุฐู ุงููุฌูุฏ ุจุงููุงูู: src/modules/services/inventory/oils-greases.  
2. **ุฅูุดุงุก ุฎุฏูุฉ ููุญุฏุฉ:**  
   * ุฃูุดุฆ src/modules/services/inventory/inventory.service.ts.  
   * ูุฌุจ ุฃู ุชุญุชูู ูุฐู ุงูุฎุฏูุฉ ุนูู ุงูููุทู ุงูููุญุฏ:  
     * createItem(data): ูุฅุถุงูุฉ ุตูู ุฌุฏูุฏ (ูู INV\_Item).  
     * getStock(itemId, locationId): ูุฌูุจ ุงูุฑุตูุฏ (ูู INV\_Stock).  
     * createTransaction(data): **ุฃูู ูุธููุฉ**. ุชููู ุจุฅูุดุงุก ุณุฌู INV\_Transaction ูุชุญุฏูุซ ุงูุฑุตูุฏ ูู INV\_Stock (ุจูุง ูู ุฐูู ุฅุนุงุฏุฉ ุญุณุงุจ averageCost ุนูุฏ ุงูุดุฑุงุก).  
3. **ุชุนุฏูู ูุงุฌูุงุช ุงูุจูุช (Handlers):**  
   * ุงุญุฐู ุงููุฌูุฏ ุจุงููุงูู: src/bot/features/inventory-management/handlers/oils-greases/.  
   * ุนุฏูู ุงูู Handlers ุงูุฎุงุตุฉ ุจู spare-parts- (ูุซู spare-parts-items.handler.ts) ูุชุณุชุฎุฏู ุงูุฎุฏูุฉ ุงูููุญุฏุฉ inventory.service.ts.  
   * **ุงููุจุฏุฃ:**  
     * ุงูุฒุฑ "ูุฎุฒู ูุทุน ุงูุบูุงุฑ" ุณูุณุชุฏุนู inventoryService.getItems({ categoryCode: 'SPARE\_PART' }).  
     * ุงูุฒุฑ "ูุฎุฒู ุงูุฒููุช ูุงูุดุญูู" ุณูุณุชุฏุนู inventoryService.getItems({ categoryCode: 'OILS\_GREASE' }).  
   * ุจูุฐุง ุงูุดููุ ุฃูุช ุชุณุชุฎุฏู **ููุณ ุงูููุฏ** ู **ููุณ ุงูุฌุฏุงูู**ุ ูุน ุชุบููุฑ ุงูููุชุฑ ููุท.