# ๐ ุชุญููู ุชุฏูู ุฅุฏุงุฑุฉ ุงูุฃุตูุงู - ูุทุน ุงูุบูุงุฑ

## ๐ฏ ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ

### 1๏ธโฃ ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ (Add Item)

#### ุงูุชุฏูู ุงููุงูู:
```
sp:items:add:start
  โ
[ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฅุฏุฎุงู]
  โโโ ูุณุญ ุจุงุฑููุฏ (sp:items:add:scan)
  โ     โ
  โ   [ุงูุชุธุงุฑ ุตูุฑุฉ] โ ูุนุงูุฌ ุงูุตูุฑ โ ูุณุญ ุงูุจุงุฑููุฏ
  โ     โ
  โ   [ุงูุชุญูู ูู ุงูุชูุฑุงุฑ]
  โ     โ
  โ   [ุฅุฏุฎุงู ุงูุงุณู ุจุงูุนุฑุจูุฉ]
  โ
  โโโ ุฅุฏุฎุงู ูุฏูู (sp:items:add:manual)
        โ
      [ุฅุฏุฎุงู ุจุงุฑููุฏ ุฃู ุชูููุฏ ุชููุงุฆู]
        โ
      [ุงูุชุญูู ูู ุงูุชูุฑุงุฑ]

โ [ูุณุงุฑ ููุญุฏ]

[ุฅุฏุฎุงู ุงูุงุณู ุจุงูุนุฑุจูุฉ] (awaiting_name_ar)
  โ
[ุงุฎุชูุงุฑ ุงูุชุตููู] (awaiting_category)
  โ [ุชูููุฏ ุงูููุฏ ุชููุงุฆูุงู ุจูุงุกู ุนูู ุงูุชุตููู]
  โ
[ุงุฎุชูุงุฑ ุงููููุน] (awaiting_location)
  โ
[ุงุฎุชูุงุฑ ุงูุญุงูุฉ: ุฌุฏูุฏ/ูุณุชุนูู/ูุฌุฏุฏ/ุงุณุชูุฑุงุฏ] (awaiting_condition)
  โ
[ุฅุฏุฎุงู ุงููููุฉ] (awaiting_quantity)
  โ
[ุฅุฏุฎุงู ุงูุณุนุฑ - ุงุฎุชูุงุฑู] (awaiting_price)
  โ
[ุฅุฏุฎุงู ููุงุญุธุงุช - ุงุฎุชูุงุฑู] (awaiting_notes)
  โ
[ุฑูุน ุตูุฑ - ุงุฎุชูุงุฑู] (awaiting_images)
  โ
[ูุฑุงุฌุนุฉ ููุงุฆูุฉ ูุชุฃููุฏ]
  โ
[ุงูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช]
  โ
[ุฅุฑุณุงู ุชูุฑูุฑ ูููุณุคูููู]
```

#### ุงููุธุงุฆู ุงููุณุชุฎุฏูุฉ:
- `generateInternalCode()` - ุชูููุฏ ููุฏ ุชููุงุฆู
- `BarcodeScannerService.scanBarcode()` - ูุณุญ ุงูุจุงุฑููุฏ
- ูุนุงูุฌ ุงูุตูุฑ ุงูููุญุฏ (message:photo)
- ูุนุงูุฌ ุงููุตูุต (message:text) ูุน steps ูุชุนุฏุฏุฉ

---

### 2๏ธโฃ ุงูุจุญุซ ุนู ุตูู (Search Item)

#### ุทุฑู ุงูุจุญุซ:
```
sp:items:search
  โ
[ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุจุญุซ]
  โโโ ุจุงูุจุงุฑููุฏ (ูุณุญ) โ sp:items:search:barcode-scan
  โโโ ุจุงูุจุงุฑููุฏ (ูุฏูู) โ sp:items:search:barcode-manual
  โโโ ุจุงูููุฏ ุงูุฏุงุฎูู โ sp:items:search:code
  โโโ ุจุงูุงุณู โ sp:items:search:name
  โโโ ุจุงูุชุตููู โ sp:items:search:category
  โโโ ุจุงููููุน โ sp:items:search:location
```

#### ุงูุชุฏููุงุช:
1. **ุจุงูุจุงุฑููุฏ (ูุณุญ):**
   - ุงูุชุธุงุฑ ุตูุฑุฉ โ ูุณุญ โ ุนุฑุถ ุงููุชูุฌุฉ

2. **ุจุงูุจุงุฑููุฏ (ูุฏูู):**
   - ุฅุฏุฎุงู ูุต โ ุงูุจุญุซ โ ุนุฑุถ ุงููุชูุฌุฉ

3. **ุจุงูููุฏ:**
   - ุฅุฏุฎุงู ูุต โ ุงูุจุญุซ โ ุนุฑุถ ุงููุชูุฌุฉ

4. **ุจุงูุงุณู:**
   - ุฅุฏุฎุงู ูุต โ ุงูุจุญุซ
   - ูุชูุฌุฉ ูุงุญุฏุฉ โ ุนุฑุถ ูุจุงุดุฑ
   - ุนุฏุฉ ูุชุงุฆุฌ โ ูุงุฆูุฉ ููุงุฎุชูุงุฑ

5. **ุจุงูุชุตููู:**
   - ุนุฑุถ ูุงุฆูุฉ ุงูุชุตูููุงุช
   - ุงุฎุชูุงุฑ ุชุตููู
   - ุนุฑุถ ุฌููุน ุงููุทุน ูู ูุฐุง ุงูุชุตููู

---

### 3๏ธโฃ ุนุฑุถ ุชูุงุตูู ุตูู (View Item)

```
sp:items:view:{itemId}
  โ
[ุนุฑุถ ูุนูููุงุช ูุงููุฉ]
  - ุงูุงุณู (ุนุฑุจู/ุฅูุฌููุฒู)
  - ุงูููุฏ ูุงูุจุงุฑููุฏ
  - ุงูุชุตููู ูุงููููุน
  - ุงููููุงุช ุงูุชูุตูููุฉ (ุฌุฏูุฏ/ูุณุชุนูู/ูุฌุฏุฏ/ุงุณุชูุฑุงุฏ)
  - ุงูุฃุณุนุงุฑ ูุงููููุฉ
  - ุงูุตูุฑ (ุฅู ูุฌุฏุช)
  - ุงูููุงุญุธุงุช
  
[ุงูุฃุฒุฑุงุฑ ุงููุชุงุญุฉ]
  โโโ ุชุนุฏูู (sp:items:edit:{id})
  โโโ ุนุฑุถ ุงูุตูุฑ (sp:items:images:{id})
  โโโ ุนุฑุถ ุงูุญุฑูุงุช (sp:trans:item:{id})
```

#### ุฏุงูุฉ ูุณุงุนุฏุฉ:
- `formatQuantityDetails()` - ุนุฑุถ ุงููููุงุช ุงูุชูุตูููุฉ

---

### 4๏ธโฃ ุชุนุฏูู ุตูู (Edit Item)

```
sp:items:edit:{itemId}
  โ
[ูุงุฆูุฉ ุฎูุงุฑุงุช ุงูุชุนุฏูู]
  โโโ ุชุนุฏูู ุงูุงุณู (edit_name)
  โโโ ุชุนุฏูู ุงููููุฉ (edit_quantity)
  โโโ ุชุนุฏูู ุงูุญุฏ ุงูุฃุฏูู (edit_minQuantity)
  โโโ ุชุนุฏูู ุงูุณุนุฑ (edit_price)
  โโโ ุชุนุฏูู ุงูุชุตููู (edit:category)
  โโโ ุชุนุฏูู ุงููููุน (edit:location)
  โโโ ุชุนุฏูู ุงูุญุงูุฉ (edit:condition)
  โโโ ุชุนุฏูู ุงูููุงุญุธุงุช (edit_notes)
  โโโ ุญุฐู ุงููุทุนุฉ (delete)
```

#### ุฃููุงุน ุงูุชุนุฏูู:
1. **ุชุนุฏูู ูุตู** (ุงูุงุณูุ ุงูููุงุญุธุงุช):
   - ุญูุธ ุงูุญุงูุฉ ูู session
   - ุงูุชุธุงุฑ ุฅุฏุฎุงู ูุตู
   - ุงูุชุญุฏูุซ ูู DB
   - ุนุฑุถ ุชุฃููุฏ

2. **ุชุนุฏูู ุฑููู** (ุงููููุฉุ ุงูุณุนุฑุ ุงูุญุฏ ุงูุฃุฏูู):
   - ุญูุธ ุงูุญุงูุฉ ูู session
   - ุงูุชุธุงุฑ ุฅุฏุฎุงู ุฑููู
   - ุงูุชุญูู ูู ุงูุตุญุฉ
   - ุงูุชุญุฏูุซ ูู DB + ุฅุนุงุฏุฉ ุญุณุงุจ ุงููููุฉ
   - ุนุฑุถ ุชุฃููุฏ

3. **ุชุนุฏูู ุจุงุฎุชูุงุฑ** (ุงูุชุตูููุ ุงููููุนุ ุงูุญุงูุฉ):
   - ุนุฑุถ ูุงุฆูุฉ ุงูุฎูุงุฑุงุช
   - ุงุฎุชูุงุฑ ูุจุงุดุฑ
   - ุงูุชุญุฏูุซ ูู DB
   - ุนุฑุถ ุชุฃููุฏ

---

### 5๏ธโฃ ุนุฑุถ ูุงุฆูุฉ ุงูุฃุตูุงู (List Items)

```
sp:items:list
  โ
[ุนุฑุถ ูุงุฆูุฉ ูุฑููุฉ ูุน pagination]
  - 15 ุตูู ูู ุงูุตูุญุฉ
  - ุญุงูุฉ ุงููุฎุฒูู (๐ข ๐ก ๐ด)
  - ุฃุฒุฑุงุฑ ุงูุชููู (ุงูุณุงุจู/ุงูุชุงูู)
  
[ุงูุถุบุท ุนูู ุตูู]
  โ
sp:items:view:{id}
```

---

### 6๏ธโฃ ุนุฑุถ ุตูุฑ ุงูุตูู (View Images)

```
sp:items:images:{itemId}
  โ
[ุฌูุน ุฌููุน ุงูุตูุฑ]
  - ุงูุตูุฑุฉ ุงูุฑุฆูุณูุฉ (imagePath)
  - ุงูุตูุฑ ุงูุฅุถุงููุฉ (images JSON)
  
[ุฅุฑุณุงู ูู ุตูุฑุฉ]
  โ
[ุนุฑุถ ุฃุฒุฑุงุฑ ุงูุชุญูู]
```

---

### 7๏ธโฃ ุญุฐู ุตูู (Delete Item)

```
sp:items:delete:{itemId}
  โ
[ุทูุจ ุชุฃููุฏ]
  โ
sp:items:delete:confirm:{id}
  โ
[ุญุฐู ูุงุนู - isActive = false]
  โ
[ุชุณุฌูู ูู Audit Log]
  โ
[ุฅุฑุณุงู ุชูุฑูุฑ ูููุณุคูููู]
```

---

## ๐ง ุงููุนุงูุฌุงุช ุงูุฎุงุตุฉ

### ูุนุงูุฌ ุงูุตูุฑ (Photo Handler)
```typescript
on('message:photo')
  โ
[ูุญุต ุงูุญุงูุฉ ูู session]
  โโโ awaiting_barcode_image
  โ     โ
  โ   [ูุณุญ ุงูุจุงุฑููุฏ]
  โ   [ุงูุชุญูู ูู ุงูุชูุฑุงุฑ]
  โ   [ุงูุงูุชูุงู ููุฎุทูุฉ ุงูุชุงููุฉ]
  โ
  โโโ awaiting_images
        โ
      [ุญูุธ ุงูุตูุฑุฉ ูู uploads/]
      [ุฅุถุงูุฉ ุงููุณุงุฑ ููู session]
      [ุนุฑุถ ุฎูุงุฑุงุช: ุฅุถุงูุฉ ุฃุฎุฑู / ุฅููุงุก]
```

### ูุนุงูุฌ ุงููุตูุต (Text Handler)
```typescript
on('message:text')
  โ
[ูุญุต ุงูุญุงูุฉ ูู session]
  โโโ awaiting_name_ar
  โโโ awaiting_quantity
  โโโ awaiting_price
  โโโ awaiting_notes
  โโโ edit_name
  โโโ edit_quantity
  โโโ edit_minQuantity
  โโโ edit_price
  โโโ edit_notes
  โโโ search_by_barcode
  โโโ search_by_code
  โโโ search_by_name
```

---

## ๐ฆ ุงููุธุงุฆู ุงููุณุงุนุฏุฉ

### 1. `generateInternalCode(categoryCode)`
- ุชูููุฏ ููุฏ ุชููุงุฆู ุจูุงุกู ุนูู ุงูุชุตููู
- ูุซุงู: `CAR-00001`, `LOADER-00023`

### 2. `formatQuantityDetails(item)`
- ุนุฑุถ ุงููููุงุช ุงูุชูุตูููุฉ
- ุฌุฏูุฏ / ูุณุชุนูู / ูุฌุฏุฏ / ุงุณุชูุฑุงุฏ

### 3. `sendReportToAdmins(ctx, item, category, location)`
- ุฅุฑุณุงู ุชูุฑูุฑ ูููุณุคูููู ุนูุฏ ุฅุถุงูุฉ ุตูู
- ุฌูุจ admins ูู DepartmentAdmin

### 4. `sendDeleteReportToAdmins(ctx, item)`
- ุฅุฑุณุงู ุชูุฑูุฑ ุนูุฏ ุญุฐู ุตูู

### 5. `showFinalConfirmation(ctx)`
- ุนุฑุถ ูุฑุงุฌุนุฉ ููุงุฆูุฉ ูุจู ุงูุญูุธ

---

## ๐๏ธ Session State Structure

```typescript
ctx.session.inventoryForm = {
  action: 'add' | 'edit' | 'search',
  step: string,  // ุงูุฎุทูุฉ ุงูุญุงููุฉ
  data: {
    // ุจูุงูุงุช ูุคูุชุฉ ุญุณุจ ุงููุธููุฉ
    barcode?: string,
    nameAr?: string,
    categoryId?: number,
    code?: string,
    locationId?: number,
    condition?: string,
    quantity?: number,
    unitPrice?: number,
    notes?: string,
    images?: string[],
    // ููุชุนุฏูู
    itemId?: number,
    currentValue?: any,
    // ููุจุญุซ
    flow?: string
  }
}
```

---

## ๐จ Callback Patterns

### ุฅุถุงูุฉ:
- `sp:items:add:start`
- `sp:items:add:scan`
- `sp:items:add:manual`
- `sp:items:add:auto-barcode`
- `sp:items:add:confirm-barcode:{barcode}`
- `sp:items:add:select_category:{id}`
- `sp:items:add:select_location:{id}`
- `sp:items:add:select_condition:{condition}`
- `sp:items:add:skip_price`
- `sp:items:add:skip_notes`
- `sp:items:add:skip_images`
- `sp:items:add:confirm_save`

### ุจุญุซ:
- `sp:items:search`
- `sp:items:search:barcode-scan`
- `sp:items:search:barcode-manual`
- `sp:items:search:code`
- `sp:items:search:name`
- `sp:items:search:category`
- `sp:items:by-category:{id}`

### ุนุฑุถ ูุชุนุฏูู:
- `sp:items:view:{id}`
- `sp:items:edit:{id}`
- `sp:items:edit:{id}:name`
- `sp:items:edit:{id}:quantity`
- `sp:items:edit:{id}:minQuantity`
- `sp:items:edit:{id}:price`
- `sp:items:edit:{id}:category`
- `sp:items:edit:{id}:category:{catId}`
- `sp:items:edit:{id}:location`
- `sp:items:edit:{id}:location:{locId}`
- `sp:items:edit:{id}:condition`
- `sp:items:edit:{id}:condition:{cond}`
- `sp:items:edit:{id}:notes`

### ุญุฐู:
- `sp:items:delete:{id}`
- `sp:items:delete:confirm:{id}`

### ูุงุฆูุฉ ูุตูุฑ:
- `sp:items:list`
- `sp:items:list:{page}`
- `sp:items:images:{id}`

---

## ๐ ุงูุชููู ููุฎุฒู ุงูุฒููุช ูุงูุดุญูู

### ุงูุชุบููุฑุงุช ุงููุทููุจุฉ:

1. **Prefix ุงูุชุบููุฑ:**
   - `sp:` โ `og:` (oils-greases)

2. **ุงูุฌุฏุงูู:**
   - `INV_SparePart` โ `INV_OilsGreasesItem`
   - `INV_EquipmentCategory` โ `INV_OilsGreasesCategory`
   - `INV_StorageLocation` (ููุณู - ูุดุชุฑู)

3. **ุงูุญููู ุงููุฎุชููุฉ:**
   - ูุทุน ุงูุบูุงุฑ: `quantityNew`, `quantityUsed`, `quantityRefurbished`, `quantityImport`
   - ุงูุฒููุช: `quantity` ููุท (ุจุณูุท)

4. **ุชูููุฏ ุงูููุฏ:**
   - ูุทุน ุงูุบูุงุฑ: `CAR-00001`, `LOADER-00023`
   - ุงูุฒููุช: `ENG-001`, `GRS-002`, `HYD-003`

5. **ุงูุญุงูุฉ (Condition):**
   - ูุทุน ุงูุบูุงุฑ: NEW, USED, REFURBISHED, IMPORT
   - ุงูุฒููุช: ุบูุฑ ูุทููุจ (ูููุง ุฌุฏูุฏุฉ)

---

## โ ุงููุธุงุฆู ุงูุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู

ูู `src/bot/features/inventory-management/`:

### Services:
- โ `TransactionService` - ููุญุฑูุงุช
- โ `WarehouseService` - ููุนูููุงุช ุงูุนุงูุฉ
- โ `AuditService` - ููุชุฏููู

### Utils:
- โ `validators.util.ts` - ุงูุชุญูู
- โ `formatters.util.ts` - ุงูุชูุณูู
- โ `code-generator.util.ts` - ุชูููุฏ ุงูุฃููุงุฏ
- โ `category-selector.util.ts` - ุงุฎุชูุงุฑ ุงููุฆุงุช
- โ `barcode-handler.util.ts` - ุฅุฏุงุฑุฉ ุงูุจุงุฑููุฏ

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ูุนุงูุฌ ุงูุตูุฑ ูุงููุตูุต:**
   - ูุฌุจ ุฃู ูููู ูู ุฃุนูู ูุณุชูู (handler ุฑุฆูุณู)
   - ูุญุต ุฏููู ููู session state
   - pass to next() ุฅุฐุง ูู ุชูู ุงูุญุงูุฉ ููุงุณุจุฉ

2. **Session Management:**
   - ุญูุธ ุงูุญุงูุฉ ูู ูู ุฎุทูุฉ
   - ูุณุญ ุงูุญุงูุฉ ุนูุฏ ุงูุฅููุงุก/ุงูุฅูุบุงุก
   - ุงูุชุญูู ูู ูุฌูุฏ ุงูุญุงูุฉ ูุจู ุงููุนุงูุฌุฉ

3. **ุงูุชุญูู ูู ุงูุชูุฑุงุฑ:**
   - ูุญุต ุงูุจุงุฑููุฏ ูุจู ุงูุญูุธ
   - ุนุฑุถ ูุนูููุงุช ุงูุตูู ุงูููุฌูุฏ
   - ุฎูุงุฑ ุนุฑุถ ุงูุชูุงุตูู

4. **ุงูุชูุงุฑูุฑ ูููุณุคูููู:**
   - ุฌูุจ ูู `DepartmentAdmin`
   - ุฅุฑุณุงู ุตุงูุช ูู ุงูุฎูููุฉ
   - ุนุฏู ุฅุฑุณุงู ูููุณุชุฎุฏู ููุณู

5. **ุงูุญุฐู ุงููุงุนู:**
   - `isActive = false`
   - ุฅููุงููุฉ ุงูุงุณุชุฑุฌุงุน
   - ุชุณุฌูู ูู Audit Log
